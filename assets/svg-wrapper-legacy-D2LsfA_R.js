!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){n(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-RDLacvTL.js","./index-legacy-DRXAoLBp.js","./master-manager-legacy-CZ8HZ7XP.js","./react-legacy-CczY7eHI.js","./clipboard-legacy-R0_43CNY.js","./misc-nodes-legacy-gRGmvSOo.js"],(function(e,n){"use strict";var r,i,o,s,a,c,l,d,u,h,y,g,p,f,x,m,v,b,w,P,j,A,z,N,k,S,D,M,E,_,C,$,I,O,H,W,T,B,L,K,R,X,Y,U,V,F,Q,Z,q,J,G,ee,te,ne,re,ie,oe,se,ae,ce,le,de,ue;return{setters:[e=>{r=e.j,i=e.ad},e=>{o=e.N,s=e.aq,a=e.ar,c=e.a3,l=e.k,d=e.o,u=e.as,h=e.at,y=e.au,g=e.av,p=e.c,f=e.d,x=e.p,m=e.aw,v=e.ax,b=e.ay,w=e.az,P=e.T,j=e.aA,A=e.aB,z=e.aC,N=e.q,k=e.t,S=e.aD,D=e.n,M=e.m,E=e.l,_=e.r,C=e.E,$=e.v,I=e.y,O=e.U,H=e.aE,W=e.aF,T=e.S,B=e.aG,L=e.a0,K=e.aa,R=e.A,X=e.an,Y=e.ao,U=e.z,V=e.a1},e=>{F=e.s,Q=e.u,Z=e.f,q=e.g,J=e.b,G=e.c,ee=e.e,te=e.h,ne=e.F,re=e.l,ie=e.S,oe=e.j},e=>{se=e.j,ae=e.b},e=>{ce=e.u,le=e.e,de=e.i},e=>{ue=e.m}],execute:function(){const n={[c.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[c.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},he=se("runtime/getStationNames",(async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:i}=t().account;if(!i)return void n(s({cityName:e,names:[]}));const c=await fetch(`${a}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${i}`}});if(!c.ok)return o.warn("Failed to fetch random station names",c.statusText),r(c.statusText);const l=await c.json();n(s({cityName:e,names:l}))})),ye=se("runtime/getOneStationName",(async(e,{getState:t,dispatch:r})=>{var i;const{stationNames:a}=t().runtime,c=a[e];if(0==(null!==(i=null==c?void 0:c.length)&&void 0!==i?i:0))return o.debug("No random station names in cache, using fallback"),r(he({cityName:e})),Object.values((e=>{const t=n[e];return t.at(Math.floor(Math.random()*t.length))})(e));const l=structuredClone(c),d=l.shift();return r(s({cityName:e,names:l})),l.length<3&&r(he({cityName:e})),Object.values(d)})),ge=(e,t,n,r,i,o)=>{if(!("offsetFrom"in o)||!("offsetTo"in o))return;if(Number.isNaN(o.offsetFrom)||Number.isNaN(o.offsetTo))return;if(o.offsetFrom===o.offsetTo)return fe(e,t,n,r,i)?{x1:t,y1:n,x2:r,y2:i,offset:o.offsetFrom}:void 0;const[s,a]=[o.offsetFrom,o.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let o=c,l=0;l<2;l++,o+=Math.PI){const[l,d,u,h]=[Math.sin(c)*s,Math.cos(c)*s,Math.sin(o)*a,Math.cos(o)*a];if(fe(e,t+l,n+d,r+u,i+h))return{x1:t+l,y1:n+d,x2:r+u,y2:i+h,offset:0}}},pe=(e,t,n,r,i,o)=>e===n?{x1:e+5*o,y1:t,x2:n+5*o,y2:r,offset:i}:t===r?{x1:e,y1:t+5*o,x2:n,y2:r+5*o,offset:i}:{x1:e+5*Math.SQRT1_2*o,y1:t+5*Math.SQRT1_2*o,x2:n+5*Math.SQRT1_2*o,y2:r+5*Math.SQRT1_2*o,offset:i},fe=(e,t,n,r,i)=>!(t!==r&&n!==i||![l.Diagonal,l.Perpendicular].includes(e))||!(1!==Math.abs((i-n)/(r-t))||![l.Diagonal,l.RotatePerpendicular].includes(e)),xe=(e,t)=>{if(!t.every((t=>e.hasEdge(t))))return;const n=t.map((t=>{var n,r,i;const[o,s]=e.extremities(t),a=e.getNodeAttributes(o),c=e.getNodeAttributes(s),{type:u}=e.getEdgeAttributes(t),h=null!==(n=e.getEdgeAttribute(t,u))&&void 0!==n?n:d[u].defaultAttrs,y=ge(u,a.x,a.y,c.x,c.y,h);if(y){const{x1:e,y1:t,x2:n,y2:r,offset:i}=y;return d[l.Simple].generatePath(e,n,t,r,{offset:i})}return null!==(r=null===(i=d[u])||void 0===i?void 0:i.generatePath(a.x,c.x,a.y,c.y,h))&&void 0!==r?r:`M ${a.x} ${a.y} L ${c.x} ${c.y}`}));let r=`${n[0]} `;for(let i=1;i<t.length;i+=1)r+=n[i].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},me=e=>[...e.nodeEntries()].map((e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes})),ve=e=>{const t={},n={},r=[],i={},o=[];for(const l of e.edgeEntries()){const[e,t,r,i]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y],o=l.attributes[l.attributes.type],s=ge(l.attributes.type,e,t,r,i,o);n[l.edge]=s}for(const h of e.edgeEntries()){let s=n[h.edge];const{parallelIndex:a}=h.attributes;if(a>=0){const t=n[u(e,h.attributes.type,h.edge)];if(!t){r.push(h);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:i,offset:o}=t;s=pe(e,n,r,i,o,a)}}if(""===h.attributes.reconcileId)if(s){const e=h.edge,n=h.attributes,{x1:r,y1:i,x2:o,y2:a,offset:c}=s;t[e]={attr:n,path:d[l.Simple].generatePath(r,o,i,a,{offset:c})}}else o.push(h);else{const e=h.attributes.reconcileId;e in i?i[e].push(h):i[e]=[h]}}const s=new Set;for(;r.length;){const n=r.pop();if(s.has(n.edge))continue;const{parallel:i}=h(e,n);if(!i.length)continue;i.forEach((e=>s.add(e.edge)));const o=y(i);for(const e of i){const n=e.edge;t[n]={attr:e.attributes,path:o[n]}}}const{allReconciledLines:a,danglingLines:c}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach((t=>{if(1===t.length)return void r.push(...t.map((e=>e.edge)));const i=e.getEdgeAttribute(t.at(0),"type");if(!t.every((t=>e.getEdgeAttribute(t,"type")===i)))return void r.push(...t.map((e=>e.edge)));const o=e.getEdgeAttribute(t.at(0),"style");if(!t.every((t=>e.getEdgeAttribute(t,"style")===o)))return void r.push(...t.map((e=>e.edge)));const s={},a=new Set,c=new Set,l=Object.fromEntries(t.map((t=>{var n,r;const[i,o]=e.extremities(t);return s[i]=(null!==(n=s[i])&&void 0!==n?n:0)+1,s[o]=(null!==(r=s[o])&&void 0!==r?r:0)+1,a.add(i),c.add(o),[i,[t.edge,o]]}))),d=Array.from(a).filter((e=>1===s[e])),u=Array.from(c).filter((e=>1===s[e]));if(1!==d.length||1!==u.length)return void r.push(...t.map((e=>e.edge)));const h=d[0],y=u[0];if(h===y)return void r.push(...t.map((e=>e.edge)));const g=[l[h][0]];let p=l[h][1];for(let e=1;e<t.length;e+=1){var f;const e=null===(f=l[p])||void 0===f?void 0:f.at(1);if(!e)return void r.push(...t.map((e=>e.edge)));g.push(l[p][0]),p=e}p===y&&g.length===t.length?n.push(g):r.push(...t.map((e=>e.edge)))})),{allReconciledLines:n,danglingLines:r}})(e,i);for(const l of a){const n=xe(e,l);if(!n)continue;const r=l[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const u of c){const n=e.getEdgeAttributes(u),[r,i]=e.extremities(u),o=e.getNodeAttributes(r),s=e.getNodeAttributes(i);t[u]={attr:n,path:d[l.Simple].generatePath(o.x,s.x,o.y,s.y,d[l.Simple].defaultAttrs)}}for(const l of o){const e=l.edge,n=l.attributes.type,r=l.attributes,[i,o,s,a]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y];n in d?t[e]={attr:r,path:d[n].generatePath(i,s,o,a,r[n])}:t[e]={attr:r,path:`M ${i} ${o} L ${s} ${a}`}}return Object.entries(t).map((([e,t])=>({id:e,type:"line",line:t})))},be=e=>{const{id:t,x:n,y:i,handlePointerDown:o,handlePointerMove:s,handlePointerUp:a}=e,c=ae.useCallback((e=>o(t,e)),[t,o]),l=ae.useCallback((e=>s(t,e)),[t,s]),d=ae.useCallback((e=>a(t,e)),[t,a]);return r.jsx("g",{id:t,transform:`translate(${n-6.4} ${i-6.4})scale(0.025)`,onPointerDown:c,onPointerMove:l,onPointerUp:d,style:{cursor:"move"},children:r.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},we=e=>{const{id:t,path:n,handlePointerDown:i}=e,o=ae.useCallback((e=>i(t,e)),[t,i]);return r.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},Pe=ae.memo((e=>{const{elements:t,handlePointerDown:n,handlePointerMove:i,handlePointerUp:o,handleEdgePointerDown:s}=e,a=Object.fromEntries(Array.from({length:21},((e,t)=>[t-10,{pre:[],main:[],post:[]}])));for(const w of t)if("line"===w.type){var c,l,d,u;const e=w.line.attr.type,t=w.line.attr.style,n=w.line.attr[t],i=null===(c=g[t])||void 0===c?void 0:c.preComponent;i&&a[w.line.attr.zIndex].pre.push(r.jsx(i,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${w.id}.pre`));const o=null!==(l=null===(d=g[t])||void 0===d?void 0:d.component)&&void 0!==l?l:we;a[w.line.attr.zIndex].main.push(r.jsx(o,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},w.id));const h=null===(u=g[t])||void 0===u?void 0:u.postComponent;h&&a[w.line.attr.zIndex].post.push(r.jsx(h,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${w.id}.post`))}else if("station"===w.type){var h,y,p,f;const e=w.station,t=e.type,s=null===(h=F[t])||void 0===h?void 0:h.preComponent;s&&a[w.station.zIndex].pre.push(r.jsx(s,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},`${w.id}.pre`));const c=null!==(y=null===(p=F[t])||void 0===p?void 0:p.component)&&void 0!==y?y:be;a[w.station.zIndex].main.push(r.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},w.id));const l=null===(f=F[t])||void 0===f?void 0:f.postComponent;l&&a[w.station.zIndex].post.push(r.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},`${w.id}.post`))}else if("misc-node"===w.type){var x,m,v,b;const e=w.miscNode,t=e.type,s=null===(x=ue[t])||void 0===x?void 0:x.preComponent;s&&a[w.miscNode.zIndex].pre.push(r.jsx(s,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},`${w.id}.pre`));const c=null!==(m=null===(v=ue[t])||void 0===v?void 0:v.component)&&void 0!==m?m:be;a[w.miscNode.zIndex].main.push(r.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},w.id));const l=null===(b=ue[t])||void 0===b?void 0:b.postComponent;l&&a[w.miscNode.zIndex].post.push(r.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:i,handlePointerUp:o},`${w.id}.post`))}return Array.from({length:21},((e,t)=>(t-10).toString())).map((e=>[...a[e].pre,...a[e].main,...a[e].post])).flat()}),((e,t)=>e.elements===t.elements)),je=[...Object.values(T),S.Virtual,S.Master,S.LondonArrow],Ae=()=>{const e=p(),n=ae.useRef(window.graph),{telemetry:{project:i},preference:{autoParallel:o,gridLines:s}}=f((e=>e.app)),{svgViewBoxZoom:a,svgViewBoxMin:c}=f((e=>e.param)),{selected:u,refresh:{nodes:h,edges:y},mode:g,active:S,keepLastPath:T,theme:B}=f((e=>e.runtime)),L=Q(),{height:K,width:R}=x(L),[X,Y]=ae.useState(),[U,V]=ae.useState({dx:0,dy:0}),[te,ne]=ae.useState([]),[re,ie]=ae.useState([]),[oe,se]=ae.useState([]);ae.useEffect((()=>{if(!X)return;console.log("refresh snap lines");const e=m(c,a,R,K),t=Z(n.current,...Object.values(e));ie(t),ne(q(n.current,t))}),[c,a,R,K,X]);const le=ce(((t,n)=>{n.stopPropagation(),"select"===g&&e(v("free"));const r=n.currentTarget,{x:i,y:o}=b(n);r.setPointerCapture(n.pointerId),se([]),Y({x:i,y:o}),e(w(t)),n.shiftKey?u.has(t)?e(j(t)):e(A(t)):u.has(t)||e(P(new Set([t])))})),de=ce(((r,i)=>{const{x:o,y:c}=b(i);if("free"===g&&S===r){if(i.altKey||s)se([]),u.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:z(e.x-(X.x-o)*a/100,5),y:z(e.y-(X.y-c)*a/100,5)})))}));else{const e=n.current.getNodeAttribute(r,"x"),i=n.current.getNodeAttribute(r,"y"),s=e-(X.x-o)*a/100,l=i-(X.y-c)*a/100;let d=s,h=l;if(J(r,n.current)){let e=oe;if(0!==e.length&&(e=e.filter((e=>G(e,s,l)<=6))),e.length<2){const{l:t,d:n}=ee(s,l,te,re.filter((t=>!u.has(t)&&!e.some((e=>e.node===t))))),r=0===e.length||!e.some((e=>e.a===t.a&&e.b===t.b));n<3&&e.length<2&&r&&e.push(t)}if(1===e.length){const t=e[0];if(0==t.a)h=-t.c/t.b;else if(0==t.b)d=-t.c/t.a;else{h=-t.a/t.b*d+-t.c/t.b}}else if(2===e.length){const t=e[0],n=e[1],r=t.a*n.b-n.a*t.b;0!==r&&(d=-(t.c*n.b-n.c*t.b)/r,h=-(t.a*n.c-n.a*t.c)/r)}se(e)}const y=d-e,g=h-i;u.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:z(e.x+y,.01),y:z(e.y+g,.01)})))}))}e(N()),e(k())}else g.startsWith("line")&&V({dx:(X.x-o)*a/100,dy:(X.y-c)*a/100})})),he=ce(((t,r)=>{if(g.startsWith("line")){T||e(v("free"));const t=n.current.hasNode(S)&&je.includes(n.current.getNodeAttribute(S,"type"));["stn_core_","virtual_circle_"].forEach((s=>{var a;const c=null===(a=document.elementsFromPoint(r.clientX,r.clientY)[0].attributes)||void 0===a||null===(a=a.getNamedItem("id"))||void 0===a?void 0:a.value,l=null==c?void 0:c.startsWith(s);if(t&&l){const t=g.slice(5),r=`line_${D(10)}`,[a,l]=[S,c.slice(s.length)],u=o?M(n.current,t,a,l,"from"):-1;n.current.addDirectedEdgeWithKey(r,a,l,{visible:!0,zIndex:0,type:t,[t]:structuredClone(d[t].defaultAttrs),style:E.SingleColor,[E.SingleColor]:{color:B},reconcileId:"",parallelIndex:u}),e(P(new Set([r]))),i&&_.event(C.ADD_LINE,{type:t})}})),e(k()),e($(n.current.export()))}else if("free"===g&&S){const{x:t,y:i}=b(r);X.x-t==0&&X.y-i==0||e($(n.current.export()))}se([]),Y(void 0),e(w(void 0))})),ye=ce(((t,r)=>{if(r.stopPropagation(),r.shiftKey||e(I()),r.shiftKey&&u.has(t)?e(j(t)):e(A(t)),g.startsWith("station")||g.startsWith("misc-node-virtual")||g.startsWith("misc-node-master")){const s=r.clientX-document.getElementById("canvas").getBoundingClientRect().left,l=r.clientY-document.getElementById("canvas").getBoundingClientRect().top,d=g.startsWith("station"),u=D(10),h=d?`stn_${u}`:`misc_node_${u}`,y=d?g.slice(8):g.slice(10),{x:p,y:f}=O(s,l,a,c),x=d?structuredClone(F[y].defaultAttrs):structuredClone(ue[y].defaultAttrs);"color"in x&&(x.color=B),n.current.addNode(h,{visible:!0,zIndex:0,x:z(p,5),y:z(f,5),type:y,[y]:x});const m=n.current.getEdgeAttributes(t),{zIndex:b,type:w,style:j}=m,A=m[w],S=m[j],[M,E]=n.current.extremities(t),I=o?0:-1;n.current.addDirectedEdgeWithKey(`line_${D(10)}`,M,h,{visible:!0,zIndex:b,type:w,[w]:structuredClone(A),style:j,[j]:structuredClone(S),reconcileId:"",parallelIndex:I}),n.current.addDirectedEdgeWithKey(`line_${D(10)}`,h,E,{visible:!0,zIndex:b,type:w,[w]:structuredClone(A),style:j,[j]:structuredClone(S),reconcileId:"",parallelIndex:I}),n.current.dropEdge(t),e(N()),e(k()),e($(n.current.export())),i&&(_.event(C.ADD_STATION,{type:y}),_.event(C.ADD_LINE,{type:w})),e(v("free")),e(P(new Set([h])))}})),ge=ae.useMemo((()=>[...ve(n.current),...me(n.current)]),[y,h]),pe=H.component;return r.jsxs(r.Fragment,{children:[r.jsx(Pe,{elements:ge,handlePointerDown:le,handlePointerMove:de,handlePointerUp:he,handleEdgePointerDown:ye}),g.startsWith("line")&&S&&"background"!==S&&r.jsx(pe,{id:"line_create_in_progress___no_use",type:g.slice(5),path:d[g.slice(5)].generatePath(n.current.getNodeAttribute(S,"x"),n.current.getNodeAttribute(S,"x")-U.dx,n.current.getNodeAttribute(S,"y"),n.current.getNodeAttribute(S,"y")-U.dy,d[g.slice(5)].defaultAttrs),styleAttrs:{color:B},newLine:!0,handlePointerDown:()=>{}}),0!==oe.length&&oe.map((e=>r.jsx("path",{d:d[l.Simple].generatePath(...W(e,m(c,a,R,K)),d[l.Simple].defaultAttrs),stroke:"cyan",strokeWidth:a/100},`line_polyline_${e.a}_${e.b}_${e.c}_${e.node}`)))]})},ze=ae.memo((e=>{const{svgViewBoxMin:t,svgViewBoxZoom:n,svgWidth:o,svgHeight:s}=e,a="light"===i().colorMode?"#666464":"#D3D3D4",c=m(t,n,o,s),l=n>30?n>120?50:25:5,d=n/200,u={startX:z(c.xMin-l,l),endX:z(c.xMax+l,l),startY:z(c.yMin-l,l),endY:z(c.yMax+l,l)},h=Array.from({length:(u.endX-u.startX)/l+1},((e,t)=>{const n=u.startX+t*l,i=n%(5*l)==0?2*d:d;return r.jsx("line",{x1:n,y1:u.startY,x2:n,y2:u.endY,strokeWidth:i,stroke:a,opacity:"0.5"},`grid_vl_${n}`)})),y=Array.from({length:(u.endY-u.startY)/l+1},((e,t)=>{const n=u.startY+t*l,i=n%(5*l)==0?2*d:d;return r.jsx("line",{x1:u.startX,y1:n,x2:u.endX,y2:n,strokeWidth:i,stroke:a,opacity:"0.5"},`grid_hl_${n}`)})),g=Array.from({length:(u.endX-u.startX)/l/5+1},((e,t)=>{const i=z(u.startX,5*l)+5*t*l;return r.jsx("text",{x:i,y:c.yMin+n/5,fontSize:25*d,fill:a,textAnchor:"middle",opacity:"0.5",children:i},`grid_vc_${i}`)})),p=Array.from({length:(u.endY-u.startY)/l/5+1},((e,t)=>{const i=z(u.startY,5*l)+5*t*l;return r.jsx("text",{x:c.xMin+n/8,y:i,fontSize:25*d,fill:a,textAnchor:"start",opacity:"0.5",children:i},`grid_hc_${i}`)}));return r.jsxs("g",{id:"grid-lines",className:"removeMe",children:[h,y,g,p]})}),((e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight));e("default",(()=>{const e=p(),t=ae.useRef(window.graph),n=()=>{e(N()),e(k()),e($(t.current.export()))},{activeSubscriptions:i}=f((e=>e.account)),{telemetry:{project:o},preference:{randomStationsNames:s,gridLines:a}}=f((e=>e.app)),{svgViewBoxZoom:l,svgViewBoxMin:d}=f((e=>e.param)),{mode:u,lastTool:h,active:y,selected:g,keepLastPath:m,theme:j,refresh:{nodes:A},masterNodesCount:S,parallelLinesCount:M}=f((e=>e.runtime)),E=Q(),{height:H,width:W}=x(E),T=!i.RMP_CLOUD&&S+1>B,q=!i.RMP_CLOUD&&M+1>L,J=!i.RMP_CLOUD||"none"===s;ae.useEffect((()=>{const e=te(t.current);Object.entries(e).filter((([e,t])=>t&&e in ne)).forEach((([e])=>re(e)))}),[A]);const[G,ee]=ae.useState({x:0,y:0}),[se,he]=ae.useState({x:0,y:0}),[ge,pe]=ae.useState({x:0,y:0}),[fe,xe]=ae.useState({x:0,y:0}),me=ce((async r=>{const{x:i,y:s}=b(r);if(u.startsWith("station")){e(v("free"));const r=`stn_${D(10)}`,a=u.slice(8),h=structuredClone(F[a].defaultAttrs);if("color"in h&&(h.color=j),!J){const t=await e(ye(c.Shmetro));if(ye.fulfilled.match(t)){const e=t.payload;h.names.length>e.length?e.push(...Array(h.names.length-e.length).fill(e.at(-1))):h.names.length<e.length&&e.splice(h.names.length,e.length-h.names.length),h.names=e}}const{x:y,y:g}=O(i,s,l,d);t.current.addNode(r,{visible:!0,zIndex:0,x:z(y,5),y:z(g,5),type:a,[a]:h}),n(),o&&_.event(C.ADD_STATION,{type:a}),e(P(new Set([r])))}else if(u.startsWith("misc-node")){e(v("free"));const r=`misc_node_${D(10)}`,a=u.slice(10),{x:c,y:h}=O(i,s,l,d);t.current.addNode(r,{visible:!0,zIndex:0,x:z(c,5),y:z(h,5),type:a,[a]:structuredClone(ue[a].defaultAttrs)}),n(),o&&_.event(C.ADD_STATION,{type:a}),e(P(new Set([r])))}else"free"===u||u.startsWith("line")?(u.startsWith("line")&&(e(v("free")),m&&e(V(!1))),pe({x:i,y:s}),xe(d),r.shiftKey||(e(w("background")),e(I()))):"select"===u&&(ee(O(i,s,l,d)),he(O(i,s,l,d)))})),ve=ce((t=>{if("select"===u){if(0!=G.x&&0!=G.y){const{x:e,y:n}=b(t);he(O(e,n,l,d))}}else if("background"===y){const{x:n,y:r}=b(t);e(R({x:fe.x+(ge.x-n)*l/100,y:fe.y+(ge.y-r)*l/100}))}})),be=ce((n=>{if("select"===u){const{x:r,y:i}=b(n),{x:o,y:s}=O(r,i,l,d),a=Z(t.current,G.x,G.y,o,s),c=oe(t.current,new Set(a));e(P(new Set([...n.shiftKey?g:[],...a,...c]))),e(v("free")),ee({x:0,y:0}),he({x:0,y:0})}"background"!==y||n.shiftKey||e(w(void 0))})),we=ce((t=>{let n=l;t.deltaY>0&&l+10<400?n=l+10:t.deltaY<0&&l-10>0&&(n=l-10),e(U(n));const{x:r,y:i}=b(t),o=t.currentTarget.getBoundingClientRect(),[s,a]=[r/o.width,i/o.height];e(R({x:d.x+r*l/100-W*n/100*s,y:d.y+i*l/100-H*n/100*a}))})),Pe=ce((async r=>{if(K?"Backspace"===r.key:"Delete"===r.key)g.size>0&&(g.forEach((e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)})),e(I()),n());else if(r.key.startsWith("Arrow")){const t=100,n=r.key.endsWith("Left")?-1:r.key.endsWith("Right")?1:0,i=r.key.endsWith("Up")?-1:r.key.endsWith("Down")?1:0;e(R(O(t*n,t*i,l,d)))}else if("i"===r.key||"j"===r.key||"k"===r.key||"l"===r.key){const e=10,i=("j"===r.key?-1:"l"===r.key?1:0)*e,o=("i"===r.key?-1:"k"===r.key?1:0)*e;g.size>0&&g.forEach((e=>{t.current.hasNode(e)&&(t.current.updateNodeAttribute(e,"x",(e=>(null!=e?e:0)+i)),t.current.updateNodeAttribute(e,"y",(e=>(null!=e?e:0)+o)),n())}))}else if("f"===r.key&&h)e(v(h));else if("z"===r.key&&(K?r.metaKey&&!r.shiftKey:r.ctrlKey))K&&r.preventDefault(),e(X()),e(N()),e(k());else if("s"===r.key)e(v("select"));else if("c"!==r.key&&"x"!==r.key||!(K?r.metaKey&&!r.shiftKey:r.ctrlKey))if("v"===r.key&&(K?r.metaKey&&!r.shiftKey:r.ctrlKey)){const r=await navigator.clipboard.readText(),{x:i,y:o}=O(W/2,H/2,l,d),{nodes:s,edges:a}=de(r,t.current,T,q,z(i,5),z(o,5));n();const c=structuredClone(s);a.forEach((e=>c.add(e))),e(P(c))}else(K&&"z"===r.key&&r.metaKey&&r.shiftKey||!K&&"y"===r.key&&r.ctrlKey)&&(e(Y()),e(N()),e(k()));else{const i=le(t.current,g);navigator.clipboard.writeText(i),"x"===r.key&&(e(I()),g.forEach((e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)})),n())}})),[je,Ne]=ae.useState(0),ke=ce((t=>{if(2===t.touches.length){e(w(void 0));const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];Ne(n*n+r*r)}})),Se=ce((t=>{if(0!==je&&2===t.touches.length){const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],i=n*n+r*r;let o=l;i-je<0&&l+10<=390?o=l+10:i-je>0&&l-10>=10&&(o=l-10),e(U(o)),Ne(i);const s=t.currentTarget.getBoundingClientRect(),[a,c]=[(t.touches[0].clientX+t.touches[1].clientX)/2-s.left,(t.touches[0].clientY+t.touches[1].clientY)/2-s.top],[u,h]=[a/s.width,c/s.height];e(R({x:d.x+a*l/100-W*o/100*u,y:d.y+c*l/100-H*o/100*h}))}})),De=ce((e=>{0!==je&&Ne(0)})),[Me,Ee]=ae.useState({sx:0,sy:0,ex:0,ey:0});return ae.useEffect((()=>{Ee({sx:G.x<=se.x?G.x:se.x,ex:G.x>se.x?G.x:se.x,sy:G.y<=se.y?G.y:se.y,ey:G.y>se.y?G.y:se.y})}),[se.x,se.y]),r.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:H,width:W,viewBox:`${d.x} ${d.y} ${W*l/100} ${H*l/100}`,onPointerDown:me,onPointerMove:ve,onPointerUp:be,onTouchStart:ke,onTouchMove:Se,onTouchEnd:De,onWheel:we,tabIndex:0,onKeyDown:Pe,children:[a&&r.jsx(ze,{svgViewBoxMin:d,svgViewBoxZoom:l,svgWidth:W,svgHeight:H}),r.jsx(ie,{children:r.jsx(Ae,{})}),"select"===u&&0!=G.x&&0!=G.y&&r.jsx("rect",{x:Me.sx,y:Me.sy,width:Me.ex-Me.sx,height:Me.ey-Me.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),r.jsx("defs",{children:r.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[r.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),r.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})}))}}}))}();
