import{j as P,ad as Ot}from"./chakra-Bbq65mY9.js";import{N as Wt,aq as Mt,ar as Vt,a3 as Ct,k as q,o as O,as as Ft,at as Ut,au as Gt,av as Pt,d as nt,c as Bt,p as Xt,aw as Et,ax as J,ay as et,az as lt,T as ot,aA as jt,aB as Nt,aC as T,q as dt,t as ct,aD as kt,n as at,m as Zt,l as Lt,r as ut,E as ht,v as xt,y as mt,U as Q,aE as qt,aF as Qt,S as Jt,aG as te,a0 as ee,aa as st,A as pt,an as ne,ao as se,z as zt,a1 as oe}from"./index-D61SVprW.js";import{s as ft,u as Ht,f as Rt,g as ie,b as re,c as ae,e as ce,h as le,j as de,F as ue,l as he,S as fe,k as ye}from"./master-manager-BXlL3DJk.js";import{j as Kt,b as D}from"./react-DsCD0OwY.js";import{u as Z,e as ge,i as pe}from"./clipboard-B1MEKLG3.js";import{m as yt}from"./misc-nodes-Bx5GRS6A.js";const xe={[Ct.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ct.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},me=t=>{const e=xe[t];return e.at(Math.floor(Math.random()*e.length))},Dt=Kt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:y})=>{const{token:o}=e().account;if(!o){u(Mt({cityName:t,names:[]}));return}const a=await fetch("".concat(Vt,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!a.ok)return Wt.warn("Failed to fetch random station names",a.statusText),y(a.statusText);const x=await a.json();u(Mt({cityName:t,names:x}))}),$t=Kt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var c;const{stationNames:y}=e().runtime,o=y[t];if(((c=o==null?void 0:o.length)!=null?c:0)==0)return Wt.debug("No random station names in cache, using fallback"),u(Dt({cityName:t})),Object.values(me(t));const a=structuredClone(o),x=a.shift();return u(Mt({cityName:t,names:a})),a.length<3&&u(Dt({cityName:t})),Object.values(x)}),Yt=(t,e,u,y,o,a)=>{if(!("offsetFrom"in a)||!("offsetTo"in a)||Number.isNaN(a.offsetFrom)||Number.isNaN(a.offsetTo))return;if(a.offsetFrom===a.offsetTo)return It(t,e,u,y,o)?{x1:e,y1:u,x2:y,y2:o,offset:a.offsetFrom}:void 0;const[x,c]=[a.offsetFrom,a.offsetTo];for(let i=0;i<Math.PI;i+=Math.PI/8)for(let s=i,r=0;r<2;r++,s+=Math.PI){const[h,l,k,A]=[Math.sin(i)*x,Math.cos(i)*x,Math.sin(s)*c,Math.cos(s)*c];if(It(t,e+h,u+l,y+k,o+A))return{x1:e+h,y1:u+l,x2:y+k,y2:o+A,offset:0}}},ve=(t,e,u,y,o,a)=>t===u?{x1:t+5*a,y1:e,x2:u+5*a,y2:y,offset:o}:e===y?{x1:t,y1:e+5*a,x2:u,y2:y+5*a,offset:o}:{x1:t+5*Math.SQRT1_2*a,y1:e+5*Math.SQRT1_2*a,x2:u+5*Math.SQRT1_2*a,y2:y+5*Math.SQRT1_2*a,offset:o},It=(t,e,u,y,o)=>!!((e===y||u===o)&&[q.Diagonal,q.Perpendicular].includes(t)||Math.abs((o-u)/(y-e))===1&&[q.Diagonal,q.RotatePerpendicular].includes(t)),Se=(t,e)=>{const u=[],y=[];return Object.values(e).forEach(o=>{var S;if(o.length===1){y.push(...o.map(p=>p.edge));return}const a=t.getEdgeAttribute(o.at(0),"type");if(!o.every(p=>t.getEdgeAttribute(p,"type")===a)){y.push(...o.map(p=>p.edge));return}const x=t.getEdgeAttribute(o.at(0),"style");if(!o.every(p=>t.getEdgeAttribute(p,"style")===x)){y.push(...o.map(p=>p.edge));return}const c={},i=new Set,s=new Set,r=Object.fromEntries(o.map(p=>{var M,$;const[N,d]=t.extremities(p);return c[N]=((M=c[N])!=null?M:0)+1,c[d]=(($=c[d])!=null?$:0)+1,i.add(N),s.add(d),[N,[p.edge,d]]})),h=Array.from(i).filter(p=>c[p]===1),l=Array.from(s).filter(p=>c[p]===1);if(h.length!==1||l.length!==1){y.push(...o.map(p=>p.edge));return}const k=h[0],A=l[0];if(k===A){y.push(...o.map(p=>p.edge));return}const E=[r[k][0]];let w=r[k][1];for(let p=1;p<o.length;p=p+1){const N=(S=r[w])==null?void 0:S.at(1);if(!N){y.push(...o.map(d=>d.edge));return}E.push(r[w][0]),w=N}if(w!==A||E.length!==o.length){y.push(...o.map(p=>p.edge));return}u.push(E)}),{allReconciledLines:u,danglingLines:y}},be=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const u=e.map(o=>{var l,k,A;const[a,x]=t.extremities(o),c=t.getNodeAttributes(a),i=t.getNodeAttributes(x),{type:s}=t.getEdgeAttributes(o),r=(l=t.getEdgeAttribute(o,s))!=null?l:O[s].defaultAttrs,h=Yt(s,c.x,c.y,i.x,i.y,r);if(h){const{x1:E,y1:w,x2:S,y2:p,offset:N}=h;return O[q.Simple].generatePath(E,S,w,p,{offset:N})}return(A=(k=O[s])==null?void 0:k.generatePath(c.x,i.x,c.y,i.y,r))!=null?A:"M ".concat(c.x," ").concat(c.y," L ").concat(i.x," ").concat(i.y)});let y="".concat(u[0]," ");for(let o=1;o<e.length;o=o+1)y+=u[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return y},Ae=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),we=t=>{const e={},u={},y=[],o={},a=[];for(const s of t.edgeEntries()){const[r,h,l,k]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],A=s.attributes[s.attributes.type],E=Yt(s.attributes.type,r,h,l,k,A);u[s.edge]=E}for(const s of t.edgeEntries()){let r=u[s.edge];const{parallelIndex:h}=s.attributes;if(h>=0){const l=Ft(t,s.attributes.type,s.edge),k=u[l];if(!k){y.push(s);continue}if(h>0){const{x1:A,y1:E,x2:w,y2:S,offset:p}=k;r=ve(A,E,w,S,p,h)}}if(s.attributes.reconcileId!==""){const l=s.attributes.reconcileId;l in o?o[l].push(s):o[l]=[s];continue}if(r){const l=s.edge,k=s.attributes,{x1:A,y1:E,x2:w,y2:S,offset:p}=r;e[l]={attr:k,path:O[q.Simple].generatePath(A,w,E,S,{offset:p})};continue}a.push(s)}const x=new Set;for(;y.length;){const s=y.pop();if(x.has(s.edge))continue;const{parallel:r}=Ut(t,s);if(!r.length)continue;r.forEach(l=>x.add(l.edge));const h=Gt(r);for(const l of r){const k=l.edge;e[k]={attr:l.attributes,path:h[k]}}}const{allReconciledLines:c,danglingLines:i}=Se(t,o);for(const s of c){const r=be(t,s);if(!r)continue;const h=s[0];e[h]={attr:t.getEdgeAttributes(h),path:r}}for(const s of i){const r=t.getEdgeAttributes(s),[h,l]=t.extremities(s),k=t.getNodeAttributes(h),A=t.getNodeAttributes(l);e[s]={attr:r,path:O[q.Simple].generatePath(k.x,A.x,k.y,A.y,O[q.Simple].defaultAttrs)}}for(const s of a){const r=s.edge,h=s.attributes.type,l=s.attributes,[k,A,E,w]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(h in O)){e[r]={attr:l,path:"M ".concat(k," ").concat(A," L ").concat(E," ").concat(w)};continue}e[r]={attr:l,path:O[h].generatePath(k,E,A,w,l[h])}}return Object.entries(e).map(([s,r])=>({id:s,type:"line",line:r}))},Tt=t=>{const{id:e,x:u,y,handlePointerDown:o,handlePointerMove:a,handlePointerUp:x}=t,c=D.useCallback(r=>o(e,r),[e,o]),i=D.useCallback(r=>a(e,r),[e,a]),s=D.useCallback(r=>x(e,r),[e,x]);return P.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(y-6.4,")scale(0.025)"),onPointerDown:c,onPointerMove:i,onPointerUp:s,style:{cursor:"move"},children:P.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Pe=t=>{const{id:e,path:u,handlePointerDown:y}=t,o=D.useCallback(a=>y(e,a),[e,y]);return P.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},ke=D.memo(t=>{var i,s,r,h,l,k,A,E,w,S,p,N;const{elements:e,handlePointerDown:u,handlePointerMove:y,handlePointerUp:o,handleEdgePointerDown:a}=t,x=Object.fromEntries(Array.from({length:21},(d,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const d of e)if(d.type==="line"){const M=d.line.attr.type,$=d.line.attr.style,Y=d.line.attr[$],L=(i=Pt[$])==null?void 0:i.preComponent;L&&x[d.line.attr.zIndex].pre.push(P.jsx(L,{id:d.id,type:M,path:d.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},"".concat(d.id,".pre")));const V=(r=(s=Pt[$])==null?void 0:s.component)!=null?r:Pe;x[d.line.attr.zIndex].main.push(P.jsx(V,{id:d.id,type:M,path:d.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},d.id));const W=(h=Pt[$])==null?void 0:h.postComponent;W&&x[d.line.attr.zIndex].post.push(P.jsx(W,{id:d.id,type:M,path:d.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},"".concat(d.id,".post")))}else if(d.type==="station"){const M=d.station,$=M.type,Y=(l=ft[$])==null?void 0:l.preComponent;Y&&x[d.station.zIndex].pre.push(P.jsx(Y,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},"".concat(d.id,".pre")));const L=(A=(k=ft[$])==null?void 0:k.component)!=null?A:Tt;x[d.station.zIndex].main.push(P.jsx(L,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},d.id));const V=(E=ft[$])==null?void 0:E.postComponent;V&&x[d.station.zIndex].post.push(P.jsx(V,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},"".concat(d.id,".post")))}else if(d.type==="misc-node"){const M=d.miscNode,$=M.type,Y=(w=yt[$])==null?void 0:w.preComponent;Y&&x[d.miscNode.zIndex].pre.push(P.jsx(Y,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},"".concat(d.id,".pre")));const L=(p=(S=yt[$])==null?void 0:S.component)!=null?p:Tt;x[d.miscNode.zIndex].main.push(P.jsx(L,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},d.id));const V=(N=yt[$])==null?void 0:N.postComponent;V&&x[d.miscNode.zIndex].post.push(P.jsx(V,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:y,handlePointerUp:o},"".concat(d.id,".post")))}return Array.from({length:21},(d,M)=>(M-10).toString()).map(d=>[...x[d].pre,...x[d].main,...x[d].post]).flat()},(t,e)=>t.elements===e.elements),Me=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=nt(l=>l.param),y=l=>{const A=[{x:l.x,y:l.y},...l.originalNodesPos].sort((w,S)=>w.x===S.x?w.y-S.y:w.x-S.x),E=(A[1].y-A[0].y)/(A[1].x-A[0].x);if(Math.abs(E)<=.01)return{original:A,offset:A.map(w=>({x:w.x,y:w.y+10})),rotate:0};if(Math.abs(E)>=1e10)return{original:A,offset:A.map(w=>({x:w.x+10,y:w.y})),rotate:90};{const S=-1/E,p=10/Math.sqrt(S*S+1),N=10*S/Math.sqrt(S*S+1);return{original:A,offset:A.map(d=>({x:d.x+p,y:d.y+N})),rotate:-Math.atan(S)*(180/Math.PI)}}},{original:o,offset:a,rotate:x}=y(e),c=l=>{const k=Math.sqrt(3)/2*l,A="0,0",E="".concat(-l/2,",").concat(k),w="".concat(l/2,",").concat(k);return"".concat(A," ").concat(E," ").concat(w)},i=u/75,s=8*i,r="#FC8181",h="".concat(i*5," ").concat(i*2);return P.jsxs(P.Fragment,{children:[P.jsx("line",{x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y,stroke:r,strokeWidth:i,strokeDasharray:h}),P.jsx("line",{x1:a[1].x,y1:a[1].y,x2:a[2].x,y2:a[2].y,stroke:r,strokeWidth:i,strokeDasharray:h}),P.jsx("line",{x1:o[0].x,y1:o[0].y,x2:a[0].x,y2:a[0].y,stroke:r,strokeWidth:i,strokeDasharray:h}),P.jsx("line",{x1:o[1].x,y1:o[1].y,x2:a[1].x,y2:a[1].y,stroke:r,strokeWidth:i,strokeDasharray:h}),P.jsx("line",{x1:o[2].x,y1:o[2].y,x2:a[2].x,y2:a[2].y,stroke:r,strokeWidth:i,strokeDasharray:h}),P.jsx("polygon",{points:c(s),transform:"translate(".concat(a[0].x,",").concat(a[0].y,") rotate(").concat((x+270)%360,")"),fill:r}),P.jsx("polygon",{points:c(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((x+270)%360,")"),fill:r}),P.jsx("polygon",{points:c(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((x+90)%360,")"),fill:r}),P.jsx("polygon",{points:c(s),transform:"translate(".concat(a[2].x,",").concat(a[2].y,") rotate(").concat((x+90)%360,")"),fill:r})]})},Ce=[...Object.values(Jt),kt.Virtual,kt.Master,kt.LondonArrow],Ee=()=>{const t=Bt(),e=D.useRef(window.graph),u=()=>{t(dt()),t(ct()),t(xt(e.current.export()))},{telemetry:{project:y},preference:{autoParallel:o,gridLines:a}}=nt(C=>C.app),{svgViewBoxZoom:x,svgViewBoxMin:c}=nt(C=>C.param),{selected:i,refresh:{nodes:s,edges:r},mode:h,active:l,keepLastPath:k,theme:A}=nt(C=>C.runtime),E=Ht(),{height:w,width:S}=Xt(E),[p,N]=D.useState(),[d,M]=D.useState({dx:0,dy:0}),[$,Y]=D.useState([]),[L,V]=D.useState([]),[W,tt]=D.useState([]);D.useEffect(()=>{if(!p)return;console.log("refresh snap lines");const C=Et(c,x,S,w),_=Rt(e.current,...Object.values(C));V(_),Y(ie(e.current,_))},[c,x,S,w,p]);const[it,rt]=D.useState(void 0),gt=Z((C,_)=>{_.stopPropagation(),h==="select"&&t(J("free"));const H=_.currentTarget,{x:F,y:B}=et(_);H.setPointerCapture(_.pointerId),tt([]),rt(void 0),N({x:F,y:B}),t(lt(C)),_.shiftKey?i.has(C)?t(jt(C)):t(Nt(C)):i.has(C)||t(ot(new Set([C])))}),vt=Z((C,_)=>{const{x:H,y:F}=et(_);if(h==="free"&&l===C){if(!_.altKey&&!a){const B=e.current.getNodeAttribute(C,"x"),U=e.current.getNodeAttribute(C,"y"),I=B-(p.x-H)*x/100,R=U-(p.y-F)*x/100;let n=I,v=R;if(re(C,e.current)){let m=W,f=it;if(m.length!==0&&(m=m.filter(g=>ae(g,I,R)<=6)),f&&(m.length===0||Math.hypot(I-f.x,R-f.y)>6)&&(f=void 0),!f&&m.length===1){const g=m[0],{snapPoint:z,distance:X}=ce(e.current,L.filter(K=>!i.has(K)),I,R,g);X<=3&&(f=z)}if(m.length===1&&!f||m.length===0){const{l:g,d:z}=le(I,R,$,L.filter(K=>!i.has(K)&&!m.some(G=>G.node===K))),X=m.length===0||!m.some(K=>K.a===g.a&&K.b===g.b);z<3&&m.length<2&&X&&m.push(g)}if(m.length===1)if(f)n=f.x,v=f.y;else{const g=m[0];if(g.a==0)v=-g.c/g.b;else if(g.b==0)n=-g.c/g.a;else{const z=-g.a/g.b,X=-g.c/g.b;v=z*n+X}}else if(m.length===2){const g=m[0],z=m[1],X=g.a*z.b-z.a*g.b;X!==0&&(n=-(g.c*z.b-z.c*g.b)/X,v=-(g.a*z.c-z.a*g.c)/X)}tt(m),rt(f)}const b=n-B,j=v-U;i.forEach(m=>{e.current.hasNode(m)&&e.current.updateNodeAttributes(m,f=>({...f,x:T(f.x+b,.01),y:T(f.y+j,.01)}))})}else tt([]),rt(void 0),i.forEach(B=>{e.current.hasNode(B)&&e.current.updateNodeAttributes(B,U=>({...U,x:T(U.x-(p.x-H)*x/100,_.altKey?.01:5),y:T(U.y-(p.y-F)*x/100,_.altKey?.01:5)}))});t(dt()),t(ct())}else h.startsWith("line")&&M({dx:(p.x-H)*x/100,dy:(p.y-F)*x/100})}),St=Z((C,_)=>{if(h.startsWith("line")){k||t(J("free"));const H=e.current.hasNode(l)&&Ce.includes(e.current.getNodeAttribute(l,"type"));["stn_core_","virtual_circle_"].forEach(B=>{var n,v;const I=(v=(n=document.elementsFromPoint(_.clientX,_.clientY)[0].attributes)==null?void 0:n.getNamedItem("id"))==null?void 0:v.value,R=I==null?void 0:I.startsWith(B);if(H&&R){const b=h.slice(5),j="line_".concat(at(10)),[m,f]=[l,I.slice(B.length)],g=o?Zt(e.current,b,m,f,"from"):-1;e.current.addDirectedEdgeWithKey(j,m,f,{visible:!0,zIndex:0,type:b,[b]:structuredClone(O[b].defaultAttrs),style:Lt.SingleColor,[Lt.SingleColor]:{color:A},reconcileId:"",parallelIndex:g}),t(ot(new Set([j]))),y&&ut.event(ht.ADD_LINE,{type:b})}}),t(ct()),t(xt(e.current.export()))}else if(h==="free"&&l){const{x:H,y:F}=et(_);p.x-H===0&&p.y-F===0||t(xt(e.current.export()))}tt([]),rt(void 0),N(void 0),t(lt(void 0))}),bt=Z((C,_)=>{if(_.stopPropagation(),_.shiftKey||t(mt()),_.shiftKey&&i.has(C)?t(jt(C)):t(Nt(C)),h.startsWith("station")||h.startsWith("misc-node-virtual")||h.startsWith("misc-node-master")){const H=_.clientX-document.getElementById("canvas").getBoundingClientRect().left,F=_.clientY-document.getElementById("canvas").getBoundingClientRect().top,B=h.startsWith("station"),U=at(10),I=B?"stn_".concat(U):"misc_node_".concat(U),R=B?h.slice(8):h.slice(10),{x:n,y:v}=Q(H,F,x,c),b=B?structuredClone(ft[R].defaultAttrs):structuredClone(yt[R].defaultAttrs);"color"in b&&(b.color=A),e.current.addNode(I,{visible:!0,zIndex:0,x:T(n,5),y:T(v,5),type:R,[R]:b});const j=e.current.getEdgeAttributes(C),{zIndex:m,type:f,style:g}=j,z=j[f],X=j[g],[K,G]=e.current.extremities(C),_t=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),K,I,{visible:!0,zIndex:m,type:f,[f]:structuredClone(z),style:g,[g]:structuredClone(X),reconcileId:"",parallelIndex:_t}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),I,G,{visible:!0,zIndex:m,type:f,[f]:structuredClone(z),style:g,[g]:structuredClone(X),reconcileId:"",parallelIndex:_t}),e.current.dropEdge(C),u(),y&&(ut.event(ht.ADD_STATION,{type:R}),ut.event(ht.ADD_LINE,{type:f})),t(J("free")),t(ot(new Set([I])))}}),At=D.useMemo(()=>[...we(e.current),...Ae(e.current)],[r,s]),wt=qt.component;return P.jsxs(P.Fragment,{children:[P.jsx(ke,{elements:At,handlePointerDown:gt,handlePointerMove:vt,handlePointerUp:St,handleEdgePointerDown:bt}),h.startsWith("line")&&l&&l!=="background"&&P.jsx(wt,{id:"line_create_in_progress___no_use",type:h.slice(5),path:O[h.slice(5)].generatePath(e.current.getNodeAttribute(l,"x"),e.current.getNodeAttribute(l,"x")-d.dx,e.current.getNodeAttribute(l,"y"),e.current.getNodeAttribute(l,"y")-d.dy,O[h.slice(5)].defaultAttrs),styleAttrs:{color:A},newLine:!0,handlePointerDown:()=>{}}),W.length!==0&&W.map(C=>P.jsx("path",{d:O[q.Simple].generatePath(...Qt(C,Et(c,x,S,w)),O[q.Simple].defaultAttrs),stroke:"cyan",strokeWidth:x/75},"snap_line_".concat(C.a,"_").concat(C.b,"_").concat(C.c,"_").concat(C.node))),it&&P.jsx(Me,{activeSnapPoint:it})]})},_e=D.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:y,svgHeight:o}=t,x=Ot().colorMode==="light"?"#666464":"#D3D3D4",c=Et(e,u,y,o),i=u>30?u>120?50:25:5,s=u/200,r={startX:T(c.xMin-i,i),endX:T(c.xMax+i,i),startY:T(c.yMin-i,i),endY:T(c.yMax+i,i)},h=Array.from({length:(r.endX-r.startX)/i+1},(E,w)=>{const S=r.startX+w*i,p=S%(i*5)===0?2*s:s;return P.jsx("line",{x1:S,y1:r.startY,x2:S,y2:r.endY,strokeWidth:p,stroke:x,opacity:"0.5"},"grid_vl_".concat(S))}),l=Array.from({length:(r.endY-r.startY)/i+1},(E,w)=>{const S=r.startY+w*i,p=S%(i*5)===0?2*s:s;return P.jsx("line",{x1:r.startX,y1:S,x2:r.endX,y2:S,strokeWidth:p,stroke:x,opacity:"0.5"},"grid_hl_".concat(S))}),k=Array.from({length:(r.endX-r.startX)/i/5+1},(E,w)=>{const S=T(r.startX,5*i)+w*5*i;return P.jsx("text",{x:S,y:c.yMin+u/5,fontSize:s*25,fill:x,textAnchor:"middle",opacity:"0.5",children:S},"grid_vc_".concat(S))}),A=Array.from({length:(r.endY-r.startY)/i/5+1},(E,w)=>{const S=T(r.startY,5*i)+w*5*i;return P.jsx("text",{x:c.xMin+u/8,y:S,fontSize:s*25,fill:x,textAnchor:"start",opacity:"0.5",children:S},"grid_hc_".concat(S))});return P.jsxs("g",{id:"grid-lines",className:"removeMe",children:[h,l,k,A]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Ie=()=>{const t=Bt(),e=D.useRef(window.graph),u=()=>{t(dt()),t(ct()),t(xt(e.current.export()))},{activeSubscriptions:y}=nt(n=>n.account),{telemetry:{project:o},preference:{randomStationsNames:a,gridLines:x}}=nt(n=>n.app),{svgViewBoxZoom:c,svgViewBoxMin:i}=nt(n=>n.param),{mode:s,lastTool:r,active:h,selected:l,keepLastPath:k,theme:A,refresh:{nodes:E},masterNodesCount:w,parallelLinesCount:S}=nt(n=>n.runtime),p=Ht(),{height:N,width:d}=Xt(p),M=!y.RMP_CLOUD&&w+1>te,$=!y.RMP_CLOUD&&S+1>ee,Y=!y.RMP_CLOUD||a==="none";D.useEffect(()=>{const n=de(e.current);Object.entries(n).filter(([v,b])=>b&&v in ue).forEach(([v])=>he(v))},[E]);const[L,V]=D.useState({x:0,y:0}),[W,tt]=D.useState({x:0,y:0}),[it,rt]=D.useState({x:0,y:0}),[gt,vt]=D.useState({x:0,y:0}),St=Z(async n=>{const{x:v,y:b}=et(n);if(s.startsWith("station")){t(J("free"));const j=at(10),m="stn_".concat(j),f=s.slice(8),g=structuredClone(ft[f].defaultAttrs);if("color"in g&&(g.color=A),!Y){const K=await t($t(Ct.Shmetro));if($t.fulfilled.match(K)){const G=K.payload;g.names.length>G.length?G.push(...Array(g.names.length-G.length).fill(G.at(-1))):g.names.length<G.length&&G.splice(g.names.length,G.length-g.names.length),g.names=G}}const{x:z,y:X}=Q(v,b,c,i);e.current.addNode(m,{visible:!0,zIndex:0,x:T(z,5),y:T(X,5),type:f,[f]:g}),u(),o&&ut.event(ht.ADD_STATION,{type:f}),t(ot(new Set([m])))}else if(s.startsWith("misc-node")){t(J("free"));const j=at(10),m="misc_node_".concat(j),f=s.slice(10),{x:g,y:z}=Q(v,b,c,i);e.current.addNode(m,{visible:!0,zIndex:0,x:T(g,5),y:T(z,5),type:f,[f]:structuredClone(yt[f].defaultAttrs)}),u(),o&&ut.event(ht.ADD_STATION,{type:f}),t(ot(new Set([m])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(J("free")),k&&t(oe(!1))),rt({x:v,y:b}),vt(i),n.shiftKey||(t(lt("background")),t(mt()))):s==="select"&&(V(Q(v,b,c,i)),tt(Q(v,b,c,i)))}),bt=Z(n=>{if(s==="select"){if(L.x!=0&&L.y!=0){const{x:v,y:b}=et(n);tt(Q(v,b,c,i))}}else if(h==="background"){const{x:v,y:b}=et(n);t(pt({x:gt.x+(it.x-v)*c/100,y:gt.y+(it.y-b)*c/100}))}}),At=Z(n=>{if(s==="select"){const{x:v,y:b}=et(n),{x:j,y:m}=Q(v,b,c,i),f=Rt(e.current,L.x,L.y,j,m),g=ye(e.current,new Set(f));t(ot(new Set([...n.shiftKey?l:[],...f,...g]))),t(J("free")),V({x:0,y:0}),tt({x:0,y:0})}h==="background"&&!n.shiftKey&&t(lt(void 0))}),wt=Z(n=>{let v=c;n.deltaY>0&&c+10<400?v=c+10:n.deltaY<0&&c-10>0&&(v=c-10),t(zt(v));const{x:b,y:j}=et(n),m=n.currentTarget.getBoundingClientRect(),[f,g]=[b/m.width,j/m.height];t(pt({x:i.x+b*c/100-d*v/100*f,y:i.y+j*c/100-N*v/100*g}))}),C=Z(async n=>{if(st?n.key==="Backspace":n.key==="Delete")l.size>0&&(l.forEach(v=>{e.current.hasNode(v)?e.current.dropNode(v):e.current.hasEdge(v)&&e.current.dropEdge(v)}),t(mt()),u());else if(n.key.startsWith("Arrow")){const b=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,j=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(Q(100*b,100*j,c,i)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const b=(n.key==="j"?-1:n.key==="l"?1:0)*10,j=(n.key==="i"?-1:n.key==="k"?1:0)*10;l.size>0&&l.forEach(m=>{e.current.hasNode(m)&&(e.current.updateNodeAttribute(m,"x",f=>(f!=null?f:0)+b),e.current.updateNodeAttribute(m,"y",f=>(f!=null?f:0)+j),u())})}else if(n.key==="f"&&r)t(J(r));else if(n.key==="z"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey))st&&n.preventDefault(),t(ne()),t(dt()),t(ct());else if(n.key==="s")t(J("select"));else if((n.key==="c"||n.key==="x")&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const v=ge(e.current,l);navigator.clipboard.writeText(v),n.key==="x"&&(t(mt()),l.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),u())}else if(n.key==="v"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const v=await navigator.clipboard.readText(),{x:b,y:j}=Q(d/2,N/2,c,i),{nodes:m,edges:f}=pe(v,e.current,M,$,T(b,5),T(j,5));u();const g=structuredClone(m);f.forEach(z=>g.add(z)),t(ot(g))}else(st&&n.key==="z"&&n.metaKey&&n.shiftKey||!st&&n.key==="y"&&n.ctrlKey)&&(t(se()),t(dt()),t(ct()))}),[_,H]=D.useState(0),F=Z(n=>{if(n.touches.length===2){t(lt(void 0));const[v,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];H(v*v+b*b)}}),B=Z(n=>{if(_!==0&&n.touches.length===2){const[v,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],j=v*v+b*b;let m=c;j-_<0&&c+10<=390?m=c+10:j-_>0&&c-10>=10&&(m=c-10),t(zt(m)),H(j);const f=n.currentTarget.getBoundingClientRect(),[g,z]=[(n.touches[0].clientX+n.touches[1].clientX)/2-f.left,(n.touches[0].clientY+n.touches[1].clientY)/2-f.top],[X,K]=[g/f.width,z/f.height];t(pt({x:i.x+g*c/100-d*m/100*X,y:i.y+z*c/100-N*m/100*K}))}}),U=Z(n=>{_!==0&&H(0)}),[I,R]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{R({sx:L.x<=W.x?L.x:W.x,ex:L.x>W.x?L.x:W.x,sy:L.y<=W.y?L.y:W.y,ey:L.y>W.y?L.y:W.y})},[W.x,W.y]),P.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:N,width:d,viewBox:"".concat(i.x," ").concat(i.y," ").concat(d*c/100," ").concat(N*c/100),onPointerDown:St,onPointerMove:bt,onPointerUp:At,onTouchStart:F,onTouchMove:B,onTouchEnd:U,onWheel:wt,tabIndex:0,onKeyDown:C,children:[x&&P.jsx(_e,{svgViewBoxMin:i,svgViewBoxZoom:c,svgWidth:d,svgHeight:N}),P.jsx(fe,{children:P.jsx(Ee,{})}),s==="select"&&L.x!=0&&L.y!=0&&P.jsx("rect",{x:I.sx,y:I.sy,width:I.ex-I.sx,height:I.ey-I.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),P.jsx("defs",{children:P.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[P.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),P.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ie as default};
