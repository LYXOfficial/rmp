import{j as E,ad as Kt}from"./chakra-Bbq65mY9.js";import{N as Bt,aq as Et,ar as Ot,a3 as Ct,k as G,o as K,as as Vt,at as Ft,au as Ut,av as Pt,c as $t,d as ot,p as Wt,aw as _t,ax as q,ay as et,az as lt,T as it,aA as Mt,aB as Nt,aC as T,q as dt,t as at,aD as kt,n as rt,m as Zt,l as zt,r as ut,E as ht,v as xt,y as vt,U as Q,aE as Gt,aF as Qt,S as qt,aG as Jt,a0 as te,aa as st,A as mt,an as ee,ao as ne,z as Lt,a1 as se}from"./index-CFdxKmDB.js";import{s as ft,u as Xt,f as Ht,g as oe,b as ie,c as re,e as ae,h as ce,F as le,l as de,S as ue,j as he}from"./master-manager-BJOHgf-A.js";import{j as Rt,b as L}from"./react-DsCD0OwY.js";import{u as U,e as fe,i as ye}from"./clipboard-D19ASjG9.js";import{m as yt}from"./misc-nodes-D2GRJRwe.js";const ge={[Ct.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ct.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},pe=t=>{const e=ge[t];return e.at(Math.floor(Math.random()*e.length))},Dt=Rt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:d,rejectWithValue:f})=>{const{token:o}=e().account;if(!o){d(Et({cityName:t,names:[]}));return}const p=await fetch("".concat(Ot,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!p.ok)return Bt.warn("Failed to fetch random station names",p.statusText),f(p.statusText);const m=await p.json();d(Et({cityName:t,names:m}))}),jt=Rt("runtime/getOneStationName",async(t,{getState:e,dispatch:d})=>{var r;const{stationNames:f}=e().runtime,o=f[t];if(((r=o==null?void 0:o.length)!=null?r:0)==0)return Bt.debug("No random station names in cache, using fallback"),d(Dt({cityName:t})),Object.values(pe(t));const p=structuredClone(o),m=p.shift();return d(Et({cityName:t,names:p})),p.length<3&&d(Dt({cityName:t})),Object.values(m)}),Yt=(t,e,d,f,o,p)=>{if(!("offsetFrom"in p)||!("offsetTo"in p)||Number.isNaN(p.offsetFrom)||Number.isNaN(p.offsetTo))return;if(p.offsetFrom===p.offsetTo)return It(t,e,d,f,o)?{x1:e,y1:d,x2:f,y2:o,offset:p.offsetFrom}:void 0;const[m,r]=[p.offsetFrom,p.offsetTo];for(let i=0;i<Math.PI;i+=Math.PI/8)for(let s=i,a=0;a<2;a++,s+=Math.PI){const[g,h,P,k]=[Math.sin(i)*m,Math.cos(i)*m,Math.sin(s)*r,Math.cos(s)*r];if(It(t,e+g,d+h,f+P,o+k))return{x1:e+g,y1:d+h,x2:f+P,y2:o+k,offset:0}}},me=(t,e,d,f,o,p)=>t===d?{x1:t+5*p,y1:e,x2:d+5*p,y2:f,offset:o}:e===f?{x1:t,y1:e+5*p,x2:d,y2:f+5*p,offset:o}:{x1:t+5*Math.SQRT1_2*p,y1:e+5*Math.SQRT1_2*p,x2:d+5*Math.SQRT1_2*p,y2:f+5*Math.SQRT1_2*p,offset:o},It=(t,e,d,f,o)=>!!((e===f||d===o)&&[G.Diagonal,G.Perpendicular].includes(t)||Math.abs((o-d)/(f-e))===1&&[G.Diagonal,G.RotatePerpendicular].includes(t)),xe=(t,e)=>{const d=[],f=[];return Object.values(e).forEach(o=>{var A;if(o.length===1){f.push(...o.map(y=>y.edge));return}const p=t.getEdgeAttribute(o.at(0),"type");if(!o.every(y=>t.getEdgeAttribute(y,"type")===p)){f.push(...o.map(y=>y.edge));return}const m=t.getEdgeAttribute(o.at(0),"style");if(!o.every(y=>t.getEdgeAttribute(y,"style")===m)){f.push(...o.map(y=>y.edge));return}const r={},i=new Set,s=new Set,a=Object.fromEntries(o.map(y=>{var b,j;const[D,c]=t.extremities(y);return r[D]=((b=r[D])!=null?b:0)+1,r[c]=((j=r[c])!=null?j:0)+1,i.add(D),s.add(c),[D,[y.edge,c]]})),g=Array.from(i).filter(y=>r[y]===1),h=Array.from(s).filter(y=>r[y]===1);if(g.length!==1||h.length!==1){f.push(...o.map(y=>y.edge));return}const P=g[0],k=h[0];if(P===k){f.push(...o.map(y=>y.edge));return}const M=[a[P][0]];let C=a[P][1];for(let y=1;y<o.length;y=y+1){const D=(A=a[C])==null?void 0:A.at(1);if(!D){f.push(...o.map(c=>c.edge));return}M.push(a[C][0]),C=D}if(C!==k||M.length!==o.length){f.push(...o.map(y=>y.edge));return}d.push(M)}),{allReconciledLines:d,danglingLines:f}},ve=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const d=e.map(o=>{var h,P,k;const[p,m]=t.extremities(o),r=t.getNodeAttributes(p),i=t.getNodeAttributes(m),{type:s}=t.getEdgeAttributes(o),a=(h=t.getEdgeAttribute(o,s))!=null?h:K[s].defaultAttrs,g=Yt(s,r.x,r.y,i.x,i.y,a);if(g){const{x1:M,y1:C,x2:A,y2:y,offset:D}=g;return K[G.Simple].generatePath(M,A,C,y,{offset:D})}return(k=(P=K[s])==null?void 0:P.generatePath(r.x,i.x,r.y,i.y,a))!=null?k:"M ".concat(r.x," ").concat(r.y," L ").concat(i.x," ").concat(i.y)});let f="".concat(d[0]," ");for(let o=1;o<e.length;o=o+1)f+=d[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return f},Se=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),be=t=>{const e={},d={},f=[],o={},p=[];for(const s of t.edgeEntries()){const[a,g,h,P]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],k=s.attributes[s.attributes.type],M=Yt(s.attributes.type,a,g,h,P,k);d[s.edge]=M}for(const s of t.edgeEntries()){let a=d[s.edge];const{parallelIndex:g}=s.attributes;if(g>=0){const h=Vt(t,s.attributes.type,s.edge),P=d[h];if(!P){f.push(s);continue}if(g>0){const{x1:k,y1:M,x2:C,y2:A,offset:y}=P;a=me(k,M,C,A,y,g)}}if(s.attributes.reconcileId!==""){const h=s.attributes.reconcileId;h in o?o[h].push(s):o[h]=[s];continue}if(a){const h=s.edge,P=s.attributes,{x1:k,y1:M,x2:C,y2:A,offset:y}=a;e[h]={attr:P,path:K[G.Simple].generatePath(k,C,M,A,{offset:y})};continue}p.push(s)}const m=new Set;for(;f.length;){const s=f.pop();if(m.has(s.edge))continue;const{parallel:a}=Ft(t,s);if(!a.length)continue;a.forEach(h=>m.add(h.edge));const g=Ut(a);for(const h of a){const P=h.edge;e[P]={attr:h.attributes,path:g[P]}}}const{allReconciledLines:r,danglingLines:i}=xe(t,o);for(const s of r){const a=ve(t,s);if(!a)continue;const g=s[0];e[g]={attr:t.getEdgeAttributes(g),path:a}}for(const s of i){const a=t.getEdgeAttributes(s),[g,h]=t.extremities(s),P=t.getNodeAttributes(g),k=t.getNodeAttributes(h);e[s]={attr:a,path:K[G.Simple].generatePath(P.x,k.x,P.y,k.y,K[G.Simple].defaultAttrs)}}for(const s of p){const a=s.edge,g=s.attributes.type,h=s.attributes,[P,k,M,C]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(g in K)){e[a]={attr:h,path:"M ".concat(P," ").concat(k," L ").concat(M," ").concat(C)};continue}e[a]={attr:h,path:K[g].generatePath(P,M,k,C,h[g])}}return Object.entries(e).map(([s,a])=>({id:s,type:"line",line:a}))},Tt=t=>{const{id:e,x:d,y:f,handlePointerDown:o,handlePointerMove:p,handlePointerUp:m}=t,r=L.useCallback(a=>o(e,a),[e,o]),i=L.useCallback(a=>p(e,a),[e,p]),s=L.useCallback(a=>m(e,a),[e,m]);return E.jsx("g",{id:e,transform:"translate(".concat(d-6.4," ").concat(f-6.4,")scale(0.025)"),onPointerDown:r,onPointerMove:i,onPointerUp:s,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Ae=t=>{const{id:e,path:d,handlePointerDown:f}=t,o=L.useCallback(p=>f(e,p),[e,f]);return E.jsx("path",{id:e,d,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},we=L.memo(t=>{var i,s,a,g,h,P,k,M,C,A,y,D;const{elements:e,handlePointerDown:d,handlePointerMove:f,handlePointerUp:o,handleEdgePointerDown:p}=t,m=Object.fromEntries(Array.from({length:21},(c,b)=>[b-10,{pre:[],main:[],post:[]}]));for(const c of e)if(c.type==="line"){const b=c.line.attr.type,j=c.line.attr.style,H=c.line.attr[j],N=(i=Pt[j])==null?void 0:i.preComponent;N&&m[c.line.attr.zIndex].pre.push(E.jsx(N,{id:c.id,type:b,path:c.line.path,styleAttrs:H,newLine:!1,handlePointerDown:p},"".concat(c.id,".pre")));const O=(a=(s=Pt[j])==null?void 0:s.component)!=null?a:Ae;m[c.line.attr.zIndex].main.push(E.jsx(O,{id:c.id,type:b,path:c.line.path,styleAttrs:H,newLine:!1,handlePointerDown:p},c.id));const B=(g=Pt[j])==null?void 0:g.postComponent;B&&m[c.line.attr.zIndex].post.push(E.jsx(B,{id:c.id,type:b,path:c.line.path,styleAttrs:H,newLine:!1,handlePointerDown:p},"".concat(c.id,".post")))}else if(c.type==="station"){const b=c.station,j=b.type,H=(h=ft[j])==null?void 0:h.preComponent;H&&m[c.station.zIndex].pre.push(E.jsx(H,{id:c.id,x:b.x,y:b.y,attrs:b,handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},"".concat(c.id,".pre")));const N=(k=(P=ft[j])==null?void 0:P.component)!=null?k:Tt;m[c.station.zIndex].main.push(E.jsx(N,{id:c.id,x:b.x,y:b.y,attrs:b,handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},c.id));const O=(M=ft[j])==null?void 0:M.postComponent;O&&m[c.station.zIndex].post.push(E.jsx(O,{id:c.id,x:b.x,y:b.y,attrs:b,handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},"".concat(c.id,".post")))}else if(c.type==="misc-node"){const b=c.miscNode,j=b.type,H=(C=yt[j])==null?void 0:C.preComponent;H&&m[c.miscNode.zIndex].pre.push(E.jsx(H,{id:c.id,x:b.x,y:b.y,attrs:b[j],handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},"".concat(c.id,".pre")));const N=(y=(A=yt[j])==null?void 0:A.component)!=null?y:Tt;m[c.miscNode.zIndex].main.push(E.jsx(N,{id:c.id,x:b.x,y:b.y,attrs:b[j],handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},c.id));const O=(D=yt[j])==null?void 0:D.postComponent;O&&m[c.miscNode.zIndex].post.push(E.jsx(O,{id:c.id,x:b.x,y:b.y,attrs:b[j],handlePointerDown:d,handlePointerMove:f,handlePointerUp:o},"".concat(c.id,".post")))}return Array.from({length:21},(c,b)=>(b-10).toString()).map(c=>[...m[c].pre,...m[c].main,...m[c].post]).flat()},(t,e)=>t.elements===e.elements),Pe=[...Object.values(qt),kt.Virtual,kt.Master,kt.LondonArrow],ke=()=>{const t=$t(),e=L.useRef(window.graph),d=()=>{t(dt()),t(at()),t(xt(e.current.export()))},{telemetry:{project:f},preference:{autoParallel:o,gridLines:p}}=ot(w=>w.app),{svgViewBoxZoom:m,svgViewBoxMin:r}=ot(w=>w.param),{selected:i,refresh:{nodes:s,edges:a},mode:g,active:h,keepLastPath:P,theme:k}=ot(w=>w.runtime),M=Xt(),{height:C,width:A}=Wt(M),[y,D]=L.useState(),[c,b]=L.useState({dx:0,dy:0}),[j,H]=L.useState([]),[N,O]=L.useState([]),[B,J]=L.useState([]);L.useEffect(()=>{if(!y)return;console.log("refresh snap lines");const w=_t(r,m,A,C),z=Ht(e.current,...Object.values(w));O(z),H(oe(e.current,z))},[r,m,A,C,y]);const gt=U((w,z)=>{z.stopPropagation(),g==="select"&&t(q("free"));const R=z.currentTarget,{x:W,y:I}=et(z);R.setPointerCapture(z.pointerId),J([]),D({x:W,y:I}),t(lt(w)),z.shiftKey?i.has(w)?t(Mt(w)):t(Nt(w)):i.has(w)||t(it(new Set([w])))}),St=U((w,z)=>{const{x:R,y:W}=et(z);if(g==="free"&&h===w){if(!z.altKey&&!p){const I=e.current.getNodeAttribute(w,"x"),V=e.current.getNodeAttribute(w,"y"),X=I-(y.x-R)*m/100,Y=V-(y.y-W)*m/100;let $=X,Z=Y;if(ie(w,e.current)){let l=B;if(l.length!==0&&(l=l.filter(u=>re(u,X,Y)<=6)),l.length<2){const{l:u,d:v}=ae(X,Y,j,N.filter(_=>!i.has(_)&&!l.some(F=>F.node===_))),S=l.length===0||!l.some(_=>_.a===u.a&&_.b===u.b);v<3&&l.length<2&&S&&l.push(u)}if(l.length===1){const u=l[0];if(u.a==0)Z=-u.c/u.b;else if(u.b==0)$=-u.c/u.a;else{const v=-u.a/u.b,S=-u.c/u.b;Z=v*$+S}}else if(l.length===2){const u=l[0],v=l[1],S=u.a*v.b-v.a*u.b;S!==0&&($=-(u.c*v.b-v.c*u.b)/S,Z=-(u.a*v.c-v.a*u.c)/S)}J(l)}const n=$-I,x=Z-V;i.forEach(l=>{e.current.hasNode(l)&&e.current.updateNodeAttributes(l,u=>({...u,x:T(u.x+n,.01),y:T(u.y+x,.01)}))})}else J([]),i.forEach(I=>{e.current.hasNode(I)&&e.current.updateNodeAttributes(I,V=>({...V,x:T(V.x-(y.x-R)*m/100,5),y:T(V.y-(y.y-W)*m/100,5)}))});t(dt()),t(at())}else g.startsWith("line")&&b({dx:(y.x-R)*m/100,dy:(y.y-W)*m/100})}),pt=U((w,z)=>{if(g.startsWith("line")){P||t(q("free"));const R=e.current.hasNode(h)&&Pe.includes(e.current.getNodeAttribute(h,"type"));["stn_core_","virtual_circle_"].forEach(I=>{var $,Z;const X=(Z=($=document.elementsFromPoint(z.clientX,z.clientY)[0].attributes)==null?void 0:$.getNamedItem("id"))==null?void 0:Z.value,Y=X==null?void 0:X.startsWith(I);if(R&&Y){const n=g.slice(5),x="line_".concat(rt(10)),[l,u]=[h,X.slice(I.length)],v=o?Zt(e.current,n,l,u,"from"):-1;e.current.addDirectedEdgeWithKey(x,l,u,{visible:!0,zIndex:0,type:n,[n]:structuredClone(K[n].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:k},reconcileId:"",parallelIndex:v}),t(it(new Set([x]))),f&&ut.event(ht.ADD_LINE,{type:n})}}),t(at()),t(xt(e.current.export()))}else if(g==="free"&&h){const{x:R,y:W}=et(z);y.x-R===0&&y.y-W===0||t(xt(e.current.export()))}J([]),D(void 0),t(lt(void 0))}),bt=U((w,z)=>{if(z.stopPropagation(),z.shiftKey||t(vt()),z.shiftKey&&i.has(w)?t(Mt(w)):t(Nt(w)),g.startsWith("station")||g.startsWith("misc-node-virtual")||g.startsWith("misc-node-master")){const R=z.clientX-document.getElementById("canvas").getBoundingClientRect().left,W=z.clientY-document.getElementById("canvas").getBoundingClientRect().top,I=g.startsWith("station"),V=rt(10),X=I?"stn_".concat(V):"misc_node_".concat(V),Y=I?g.slice(8):g.slice(10),{x:$,y:Z}=Q(R,W,m,r),n=I?structuredClone(ft[Y].defaultAttrs):structuredClone(yt[Y].defaultAttrs);"color"in n&&(n.color=k),e.current.addNode(X,{visible:!0,zIndex:0,x:T($,5),y:T(Z,5),type:Y,[Y]:n});const x=e.current.getEdgeAttributes(w),{zIndex:l,type:u,style:v}=x,S=x[u],_=x[v],[F,ct]=e.current.extremities(w),nt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(rt(10)),F,X,{visible:!0,zIndex:l,type:u,[u]:structuredClone(S),style:v,[v]:structuredClone(_),reconcileId:"",parallelIndex:nt}),e.current.addDirectedEdgeWithKey("line_".concat(rt(10)),X,ct,{visible:!0,zIndex:l,type:u,[u]:structuredClone(S),style:v,[v]:structuredClone(_),reconcileId:"",parallelIndex:nt}),e.current.dropEdge(w),d(),f&&(ut.event(ht.ADD_STATION,{type:Y}),ut.event(ht.ADD_LINE,{type:u})),t(q("free")),t(it(new Set([X])))}}),At=L.useMemo(()=>[...be(e.current),...Se(e.current)],[a,s]),wt=Gt.component;return E.jsxs(E.Fragment,{children:[E.jsx(we,{elements:At,handlePointerDown:gt,handlePointerMove:St,handlePointerUp:pt,handleEdgePointerDown:bt}),g.startsWith("line")&&h&&h!=="background"&&E.jsx(wt,{id:"line_create_in_progress___no_use",type:g.slice(5),path:K[g.slice(5)].generatePath(e.current.getNodeAttribute(h,"x"),e.current.getNodeAttribute(h,"x")-c.dx,e.current.getNodeAttribute(h,"y"),e.current.getNodeAttribute(h,"y")-c.dy,K[g.slice(5)].defaultAttrs),styleAttrs:{color:k},newLine:!0,handlePointerDown:()=>{}}),B.length!==0&&B.map(w=>E.jsx("path",{d:K[G.Simple].generatePath(...Qt(w,_t(r,m,A,C)),K[G.Simple].defaultAttrs),stroke:"cyan",strokeWidth:m/100},"line_polyline_".concat(w.a,"_").concat(w.b,"_").concat(w.c,"_").concat(w.node)))]})},Ee=L.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:d,svgWidth:f,svgHeight:o}=t,m=Kt().colorMode==="light"?"#666464":"#D3D3D4",r=_t(e,d,f,o),i=d>30?d>120?50:25:5,s=d/200,a={startX:T(r.xMin-i,i),endX:T(r.xMax+i,i),startY:T(r.yMin-i,i),endY:T(r.yMax+i,i)},g=Array.from({length:(a.endX-a.startX)/i+1},(M,C)=>{const A=a.startX+C*i,y=A%(i*5)===0?2*s:s;return E.jsx("line",{x1:A,y1:a.startY,x2:A,y2:a.endY,strokeWidth:y,stroke:m,opacity:"0.5"},"grid_vl_".concat(A))}),h=Array.from({length:(a.endY-a.startY)/i+1},(M,C)=>{const A=a.startY+C*i,y=A%(i*5)===0?2*s:s;return E.jsx("line",{x1:a.startX,y1:A,x2:a.endX,y2:A,strokeWidth:y,stroke:m,opacity:"0.5"},"grid_hl_".concat(A))}),P=Array.from({length:(a.endX-a.startX)/i/5+1},(M,C)=>{const A=T(a.startX,5*i)+C*5*i;return E.jsx("text",{x:A,y:r.yMin+d/5,fontSize:s*25,fill:m,textAnchor:"middle",opacity:"0.5",children:A},"grid_vc_".concat(A))}),k=Array.from({length:(a.endY-a.startY)/i/5+1},(M,C)=>{const A=T(a.startY,5*i)+C*5*i;return E.jsx("text",{x:r.xMin+d/8,y:A,fontSize:s*25,fill:m,textAnchor:"start",opacity:"0.5",children:A},"grid_hc_".concat(A))});return E.jsxs("g",{id:"grid-lines",className:"removeMe",children:[g,h,P,k]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),De=()=>{const t=$t(),e=L.useRef(window.graph),d=()=>{t(dt()),t(at()),t(xt(e.current.export()))},{activeSubscriptions:f}=ot(n=>n.account),{telemetry:{project:o},preference:{randomStationsNames:p,gridLines:m}}=ot(n=>n.app),{svgViewBoxZoom:r,svgViewBoxMin:i}=ot(n=>n.param),{mode:s,lastTool:a,active:g,selected:h,keepLastPath:P,theme:k,refresh:{nodes:M},masterNodesCount:C,parallelLinesCount:A}=ot(n=>n.runtime),y=Xt(),{height:D,width:c}=Wt(y),b=!f.RMP_CLOUD&&C+1>Jt,j=!f.RMP_CLOUD&&A+1>te,H=!f.RMP_CLOUD||p==="none";L.useEffect(()=>{const n=ce(e.current);Object.entries(n).filter(([x,l])=>l&&x in le).forEach(([x])=>de(x))},[M]);const[N,O]=L.useState({x:0,y:0}),[B,J]=L.useState({x:0,y:0}),[gt,St]=L.useState({x:0,y:0}),[pt,bt]=L.useState({x:0,y:0}),At=U(async n=>{const{x,y:l}=et(n);if(s.startsWith("station")){t(q("free"));const u=rt(10),v="stn_".concat(u),S=s.slice(8),_=structuredClone(ft[S].defaultAttrs);if("color"in _&&(_.color=k),!H){const nt=await t(jt(Ct.Shmetro));if(jt.fulfilled.match(nt)){const tt=nt.payload;_.names.length>tt.length?tt.push(...Array(_.names.length-tt.length).fill(tt.at(-1))):_.names.length<tt.length&&tt.splice(_.names.length,tt.length-_.names.length),_.names=tt}}const{x:F,y:ct}=Q(x,l,r,i);e.current.addNode(v,{visible:!0,zIndex:0,x:T(F,5),y:T(ct,5),type:S,[S]:_}),d(),o&&ut.event(ht.ADD_STATION,{type:S}),t(it(new Set([v])))}else if(s.startsWith("misc-node")){t(q("free"));const u=rt(10),v="misc_node_".concat(u),S=s.slice(10),{x:_,y:F}=Q(x,l,r,i);e.current.addNode(v,{visible:!0,zIndex:0,x:T(_,5),y:T(F,5),type:S,[S]:structuredClone(yt[S].defaultAttrs)}),d(),o&&ut.event(ht.ADD_STATION,{type:S}),t(it(new Set([v])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(q("free")),P&&t(se(!1))),St({x,y:l}),bt(i),n.shiftKey||(t(lt("background")),t(vt()))):s==="select"&&(O(Q(x,l,r,i)),J(Q(x,l,r,i)))}),wt=U(n=>{if(s==="select"){if(N.x!=0&&N.y!=0){const{x,y:l}=et(n);J(Q(x,l,r,i))}}else if(g==="background"){const{x,y:l}=et(n);t(mt({x:pt.x+(gt.x-x)*r/100,y:pt.y+(gt.y-l)*r/100}))}}),w=U(n=>{if(s==="select"){const{x,y:l}=et(n),{x:u,y:v}=Q(x,l,r,i),S=Ht(e.current,N.x,N.y,u,v),_=he(e.current,new Set(S));t(it(new Set([...n.shiftKey?h:[],...S,..._]))),t(q("free")),O({x:0,y:0}),J({x:0,y:0})}g==="background"&&!n.shiftKey&&t(lt(void 0))}),z=U(n=>{let x=r;n.deltaY>0&&r+10<400?x=r+10:n.deltaY<0&&r-10>0&&(x=r-10),t(Lt(x));const{x:l,y:u}=et(n),v=n.currentTarget.getBoundingClientRect(),[S,_]=[l/v.width,u/v.height];t(mt({x:i.x+l*r/100-c*x/100*S,y:i.y+u*r/100-D*x/100*_}))}),R=U(async n=>{if(st?n.key==="Backspace":n.key==="Delete")h.size>0&&(h.forEach(x=>{e.current.hasNode(x)?e.current.dropNode(x):e.current.hasEdge(x)&&e.current.dropEdge(x)}),t(vt()),d());else if(n.key.startsWith("Arrow")){const l=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,u=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(mt(Q(100*l,100*u,r,i)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const l=(n.key==="j"?-1:n.key==="l"?1:0)*10,u=(n.key==="i"?-1:n.key==="k"?1:0)*10;h.size>0&&h.forEach(v=>{e.current.hasNode(v)&&(e.current.updateNodeAttribute(v,"x",S=>(S!=null?S:0)+l),e.current.updateNodeAttribute(v,"y",S=>(S!=null?S:0)+u),d())})}else if(n.key==="f"&&a)t(q(a));else if(n.key==="z"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey))st&&n.preventDefault(),t(ee()),t(dt()),t(at());else if(n.key==="s")t(q("select"));else if((n.key==="c"||n.key==="x")&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const x=fe(e.current,h);navigator.clipboard.writeText(x),n.key==="x"&&(t(vt()),h.forEach(l=>{e.current.hasNode(l)?e.current.dropNode(l):e.current.hasEdge(l)&&e.current.dropEdge(l)}),d())}else if(n.key==="v"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const x=await navigator.clipboard.readText(),{x:l,y:u}=Q(c/2,D/2,r,i),{nodes:v,edges:S}=ye(x,e.current,b,j,T(l,5),T(u,5));d();const _=structuredClone(v);S.forEach(F=>_.add(F)),t(it(_))}else(st&&n.key==="z"&&n.metaKey&&n.shiftKey||!st&&n.key==="y"&&n.ctrlKey)&&(t(ne()),t(dt()),t(at()))}),[W,I]=L.useState(0),V=U(n=>{if(n.touches.length===2){t(lt(void 0));const[x,l]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];I(x*x+l*l)}}),X=U(n=>{if(W!==0&&n.touches.length===2){const[x,l]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],u=x*x+l*l;let v=r;u-W<0&&r+10<=390?v=r+10:u-W>0&&r-10>=10&&(v=r-10),t(Lt(v)),I(u);const S=n.currentTarget.getBoundingClientRect(),[_,F]=[(n.touches[0].clientX+n.touches[1].clientX)/2-S.left,(n.touches[0].clientY+n.touches[1].clientY)/2-S.top],[ct,nt]=[_/S.width,F/S.height];t(mt({x:i.x+_*r/100-c*v/100*ct,y:i.y+F*r/100-D*v/100*nt}))}}),Y=U(n=>{W!==0&&I(0)}),[$,Z]=L.useState({sx:0,sy:0,ex:0,ey:0});return L.useEffect(()=>{Z({sx:N.x<=B.x?N.x:B.x,ex:N.x>B.x?N.x:B.x,sy:N.y<=B.y?N.y:B.y,ey:N.y>B.y?N.y:B.y})},[B.x,B.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:D,width:c,viewBox:"".concat(i.x," ").concat(i.y," ").concat(c*r/100," ").concat(D*r/100),onPointerDown:At,onPointerMove:wt,onPointerUp:w,onTouchStart:V,onTouchMove:X,onTouchEnd:Y,onWheel:z,tabIndex:0,onKeyDown:R,children:[m&&E.jsx(Ee,{svgViewBoxMin:i,svgViewBoxZoom:r,svgWidth:c,svgHeight:D}),E.jsx(ue,{children:E.jsx(ke,{})}),s==="select"&&N.x!=0&&N.y!=0&&E.jsx("rect",{x:$.sx,y:$.sy,width:$.ex-$.sx,height:$.ey-$.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{De as default};
