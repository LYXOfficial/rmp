import{j as E}from"./chakra-eFP61t3-.js";import{m as K,F as ie,l as F,f as be,a as V,a9 as T,aa as q,ab as Y,ac as fe,ad as ye,q as Ae,t as ce,S as we,b as Ee,n as ae,o as X,r as le,E as de,v as ue,x as Z,I as Ne,D as re,B as Ce,_ as Pe,a0 as Ie}from"./index-70ecQGTf.js";import{b as v}from"./react-82wqd3vf.js";import{u as D,e as Me,i as je}from"./clipboard-JnJ9pIV2.js";import{s as ve,F as G}from"./stations-1rPszeRu.js";import{g as B,r as $,f as _e,p as z,a as Le,b as De,i as R}from"./helpers-tMGAFNNQ.js";import{m as Se,u as Ke}from"./misc-nodes-55LX1sbh.js";const xe=t=>t.filterNodes((e,r)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),he=t=>t.filterDirectedEdges((e,r,i,s,l,d,u)=>e.startsWith("line")&&r.visible&&r.reconcileId==="").sort((e,r)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(r,"zIndex")).map(e=>{const r=t.getEdgeAttribute(e,"type"),i=t.getEdgeAttribute(e,r),s=t.getEdgeAttribute(e,"style"),l=t.getEdgeAttribute(e,s),[d,u]=t.extremities(e),f=t.getNodeAttributes(d),y=t.getNodeAttributes(u);return{edge:e,x1:f.x,y1:f.y,x2:y.x,y2:y.y,type:r,attr:i,style:s,styleAttr:l}}),ge=t=>t.filterNodes((e,r)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),We=t=>{const e=t.filterDirectedEdges((i,s,l,d,u,f,y)=>i.startsWith("line")&&s.reconcileId!==""),r={};for(const i of e){const s=t.getEdgeAttribute(i,"reconcileId");s in r?r[s].push(i):r[s]=[i]}return r},ze=t=>{const e=We(t),r=[],i=[];return Object.values(e).forEach(s=>{var W;if(s.length===1){i.push(...s);return}const l=t.getEdgeAttribute(s.at(0),"type");if(!s.every(g=>t.getEdgeAttribute(g,"type")===l)){i.push(...s);return}const d=t.getEdgeAttribute(s.at(0),"style");if(!s.every(g=>t.getEdgeAttribute(g,"style")===d)){i.push(...s);return}const u={},f=new Set,y=new Set,m=Object.fromEntries(s.map(g=>{var U,O;const[j,L]=t.extremities(g);return u[j]=((U=u[j])!=null?U:0)+1,u[L]=((O=u[L])!=null?O:0)+1,f.add(j),y.add(L),[j,[g,L]]})),S=Array.from(f).filter(g=>u[g]===1),P=Array.from(y).filter(g=>u[g]===1);if(S.length!==1||P.length!==1){i.push(...s);return}const N=S[0],I=P[0];if(N===I){i.push(...s);return}const C=[m[N][0]];let k=m[N][1];for(let g=1;g<s.length;g=g+1){const j=(W=m[k])==null?void 0:W.at(1);if(!j){i.push(...s);return}C.push(m[k][0]),k=j}if(k!==I||C.length!==s.length){i.push(...s);return}r.push(C)}),{allReconciledLines:r,danglingLines:i}},Te=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const r=e.map(s=>{var S,P,N;const[l,d]=t.extremities(s),u=t.getNodeAttributes(l),f=t.getNodeAttributes(d),y=t.getEdgeAttribute(s,"type"),m=(S=t.getEdgeAttribute(s,y))!=null?S:K[y].defaultAttrs;return(N=(P=K[y])==null?void 0:P.generatePath(u.x,f.x,u.y,f.y,m))!=null?N:"M ".concat(u.x," ").concat(u.y," L ").concat(f.x," ").concat(f.y)});let i="".concat(r[0]," ");for(let s=1;s<e.length;s=s+1)i+=r[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return i},pe=t=>{const{id:e,x:r,y:i,handlePointerDown:s,handlePointerMove:l,handlePointerUp:d}=t,u=v.useCallback(m=>s(e,m),[e,s]),f=v.useCallback(m=>l(e,m),[e,l]),y=v.useCallback(m=>d(e,m),[e,d]);return E.jsx("g",{id:e,transform:"translate(".concat(r-6.4," ").concat(i-6.4,")scale(0.025)"),onPointerDown:u,onPointerMove:f,onPointerUp:y,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ke=t=>{const{id:e,path:r,handleClick:i}=t,s=v.useCallback(l=>i(e,l),[e,i]);return E.jsx("path",{id:e,d:r,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:s})},oe=t=>{var I,C;const{id:e,type:r,attrs:i=K[r].defaultAttrs,styleType:s,styleAttrs:l=ie[s].defaultAttrs,newLine:d,handleClick:u}=t,{x1:f,y1:y,x2:m,y2:S}=t,P=v.useMemo(()=>$e(e,r,f,y,m,S,i),[r,JSON.stringify(i),f,m,y,S]),N=(C=(I=ie[s])==null?void 0:I.component)!=null?C:ke;return E.jsx(N,{id:e,type:r,path:P,styleAttrs:l,newLine:d,handleClick:u})},$e=(t,e,r,i,s,l,d)=>{if(!(e in K))return"M ".concat(r," ").concat(i," L ").concat(s," ").concat(l);const u=Be(t,e,r,i,s,l,d);if(u){const{x1:f,y1:y,x2:m,y2:S,offset:P}=u;return K[F.Simple].generatePath(f,m,y,S,{offset:P})}return K[e].generatePath(r,s,i,l,d)},Be=(t,e,r,i,s,l,d)=>{if(!("offsetFrom"in d)||!("offsetTo"in d)||Number.isNaN(d.offsetFrom)||Number.isNaN(d.offsetTo))return;if(d.offsetFrom===d.offsetTo)return me(e,r,i,s,l)?{x1:r,y1:i,x2:s,y2:l,offset:d.offsetFrom}:void 0;const[u,f]=[d.offsetFrom,d.offsetTo];for(let y=0;y<Math.PI;y+=Math.PI/8)for(let m=y,S=0;S<2;S++,m+=Math.PI){const[P,N,I,C]=[Math.sin(y)*u,Math.cos(y)*u,Math.sin(m)*f,Math.cos(m)*f];if(me(e,r+P,i+N,s+I,l+C))return{x1:r+P,y1:i+N,x2:s+I,y2:l+C,offset:0}}},me=(t,e,r,i,s)=>!!((e===i||r===s)&&[F.Diagonal,F.Perpendicular].includes(t)||Math.abs((s-r)/(i-e))===1&&[F.Diagonal,F.RotatePerpendicular].includes(t)),Oe=()=>{const t=be(),e=v.useRef(window.graph),{telemetry:{project:r}}=V(a=>a.app),{svgViewBoxZoom:i}=V(a=>a.param),{selected:s,refresh:{nodes:l,edges:d},mode:u,active:f,keepLastPath:y,theme:m}=V(a=>a.runtime),[S,P]=v.useState({x:0,y:0}),[N,I]=v.useState({x:0,y:0}),C=D((a,x)=>{x.stopPropagation(),u==="select"&&t(T("free"));const b=x.currentTarget,{x:w,y:n}=B(x);b.setPointerCapture(x.pointerId),P({x:w,y:n}),t(q(a)),x.shiftKey?s.has(a)?t(fe(a)):t(ye(a)):s.has(a)||t(Y(new Set([a])))}),k=D((a,x)=>{const{x:b,y:w}=B(x);u==="free"&&f===a?(s.forEach(n=>{e.current.hasNode(n)&&e.current.updateNodeAttributes(n,o=>({...o,x:$(o.x-(S.x-b)*i/100,x.altKey?1:5),y:$(o.y-(S.y-w)*i/100,x.altKey?1:5)}))}),t(Ae()),t(ce())):u.startsWith("line")&&I({x:(S.x-b)*i/100,y:(S.y-w)*i/100})}),W=D((a,x)=>{if(u.startsWith("line")){y||t(T("free"));const b=[...Object.values(we),Ee.Virtual],w=e.current.hasNode(f)&&b.includes(e.current.getNodeAttribute(f,"type"));["stn_core_","virtual_circle_"].forEach(o=>{var p,M;const h=(M=(p=document.elementsFromPoint(x.clientX,x.clientY)[0].attributes)==null?void 0:p.getNamedItem("id"))==null?void 0:M.value,A=h==null?void 0:h.startsWith(o);if(w&&A){const _=u.slice(5),ne="line_".concat(ae(10));e.current.addDirectedEdgeWithKey(ne,f,h.slice(o.length),{visible:!0,zIndex:0,type:_,[_]:structuredClone(K[_].defaultAttrs),style:X.SingleColor,[X.SingleColor]:{color:m},reconcileId:""}),r&&le.event(de.ADD_LINE,{type:_})}}),t(ce()),t(ue(e.current.export()))}else if(u==="free"&&f){const{x:b,y:w}=B(x);S.x-b===0&&S.y-w===0||t(ue(e.current.export()))}t(q(void 0))}),g=D((a,x)=>{x.shiftKey||t(Z()),x.shiftKey&&s.has(a)?t(fe(a)):t(ye(a))}),[j,L]=v.useState(xe(e.current)),[U,O]=v.useState(ge(e.current)),[J,H]=v.useState(he(e.current)),[Q,ee]=v.useState([]),[te,se]=v.useState([]);return v.useEffect(()=>{L(xe(e.current)),O(ge(e.current))},[l]),v.useEffect(()=>{H(he(e.current));const{allReconciledLines:a,danglingLines:x}=ze(e.current);ee(a),se(x)},[d]),E.jsxs(E.Fragment,{children:[te.map(a=>{const[x,b]=e.current.extremities(a),w=e.current.getNodeAttributes(x),n=e.current.getNodeAttributes(b);return E.jsx(oe,{id:a,x1:w.x,y1:w.y,x2:n.x,y2:n.y,newLine:!1,type:F.Simple,attrs:K[F.Simple].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:g},a)}),Q.map(a=>{var h,A;const x=Te(e.current,a);if(!x)return E.jsx(E.Fragment,{});const b=a.at(0),w=e.current.getEdgeAttribute(b,"type"),n=e.current.getEdgeAttribute(b,"style"),o=e.current.getEdgeAttribute(b,n),c=(A=(h=ie[n])==null?void 0:h.component)!=null?A:ke;return E.jsx(c,{id:b,type:w,path:x,styleAttrs:o,newLine:!1,handleClick:g},b)}),J.map(({edge:a,x1:x,y1:b,x2:w,y2:n,type:o,attr:c,style:h,styleAttr:A})=>E.jsx(oe,{id:a,x1:x,y1:b,x2:w,y2:n,newLine:!1,type:o,attrs:c,styleType:h,styleAttrs:A,handleClick:g},a)),U.map(a=>{var c,h;const{node:x,x:b,y:w,type:n}=a,o=(h=(c=Se[n])==null?void 0:c.component)!=null?h:pe;return E.jsx(o,{id:x,x:b,y:w,attrs:a[n],handlePointerDown:C,handlePointerMove:k,handlePointerUp:W},x)}),j.map(a=>{var c,h;const{node:x,x:b,y:w,type:n}=a,o=(h=(c=ve[n])==null?void 0:c.component)!=null?h:pe;return E.jsx(o,{id:x,x:b,y:w,attrs:{[n]:a[n]},handlePointerDown:C,handlePointerMove:k,handlePointerUp:W},x)}),u.startsWith("line")&&f&&E.jsx(oe,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(f,"x"),y1:e.current.getNodeAttribute(f,"y"),x2:e.current.getNodeAttribute(f,"x")-N.x,y2:e.current.getNodeAttribute(f,"y")-N.y,newLine:!0,type:u.slice(5),attrs:K[u.slice(5)].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:m}})]})},Ze=()=>{var b,w;const t=be(),e=v.useRef(window.graph),r=()=>{t(Ae()),t(ce()),t(ue(e.current.export()))},{telemetry:{project:i}}=V(n=>n.app),{svgViewBoxZoom:s,svgViewBoxMin:l}=V(n=>n.param),{mode:d,lastTool:u,active:f,selected:y,keepLastPath:m,theme:S,refresh:{nodes:P}}=V(n=>n.runtime),N=Ke(),I=((b=N.height)!=null?b:1280)-40,C=((w=N.width)!=null?w:720)-40;v.useEffect(()=>{const n=_e(e.current);Object.entries(n).filter(([o,c])=>c&&o in G).map(([o,c])=>o).filter(o=>G[o]&&document.getElementById(G[o].cssName)===null).map(o=>G[o].cssName).filter((o,c,h)=>c===h.findIndex(A=>A===o)).forEach(o=>{const c=document.createElement("link");c.rel="stylesheet",c.id=o,c.href="/rmp/styles/".concat(o,".css"),document.head.append(c)})},[P]);const[k,W]=v.useState({x:0,y:0}),[g,j]=v.useState({x:0,y:0}),[L,U]=v.useState({x:0,y:0}),[O,J]=v.useState({x:0,y:0}),H=D(n=>{const{x:o,y:c}=B(n);if(d.startsWith("station")){t(T("free"));const h=ae(10),A="stn_".concat(h),p=d.slice(8),M=structuredClone(ve[p].defaultAttrs);"color"in M&&(M.color=S);const{x:_,y:ne}=z(o,c,s,l);e.current.addNode(A,{visible:!0,zIndex:0,x:$(_,5),y:$(ne,5),type:p,[p]:M}),r(),i&&le.event(de.ADD_STATION,{type:p}),t(Y(new Set([A])))}else if(d.startsWith("misc-node")){t(T("free"));const h=ae(10),A="misc_node_".concat(h),p=d.slice(10),{x:M,y:_}=z(o,c,s,l);e.current.addNode(A,{visible:!0,zIndex:0,x:$(M,5),y:$(_,5),type:p,[p]:structuredClone(Se[p].defaultAttrs)}),r(),i&&le.event(de.ADD_STATION,{type:p}),t(Y(new Set([A])))}else d==="free"||d.startsWith("line")?(d.startsWith("line")&&(t(T("free")),m&&t(Ne(!1))),U({x:o,y:c}),J(l),n.shiftKey||(t(q("background")),t(Z()))):d==="select"&&(W(z(o,c,s,l)),j(z(o,c,s,l)))}),Q=D(n=>{if(d==="select"){if(k.x!=0&&k.y!=0){const{x:o,y:c}=B(n);j(z(o,c,s,l))}}else if(f==="background"){const{x:o,y:c}=B(n);t(re({x:O.x+(L.x-o)*s/100,y:O.y+(L.y-c)*s/100}))}}),ee=D(n=>{if(d==="select"){const{x:o,y:c}=B(n),{x:h,y:A}=z(o,c,s,l),p=Le(e.current,k.x,k.y,h,A),M=De(e.current,new Set(p));t(Y(new Set([...n.shiftKey?y:[],...p,...M]))),t(T("free")),W({x:0,y:0}),j({x:0,y:0})}f==="background"&&!n.shiftKey&&t(q(void 0))}),te=D(n=>{let o=s;n.deltaY>0&&s+10<400?o=s+10:n.deltaY<0&&s-10>0&&(o=s-10),t(Ce(o));const{x:c,y:h}=B(n),A=n.currentTarget.getBoundingClientRect(),[p,M]=[c/A.width,h/A.height];t(re({x:l.x+c*s/100-C*o/100*p,y:l.y+h*s/100-I*o/100*M}))}),se=D(async n=>{if(R?n.key==="Backspace":n.key==="Delete")y.size>0&&(y.forEach(o=>{e.current.hasNode(o)?e.current.dropNode(o):e.current.hasEdge(o)&&e.current.dropEdge(o)}),t(Z()),r());else if(n.key.startsWith("Arrow")){const c=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,h=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(re(z(100*c,100*h,s,l)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const c=(n.key==="j"?-1:n.key==="l"?1:0)*10,h=(n.key==="i"?-1:n.key==="k"?1:0)*10;y.size>0&&y.forEach(A=>{e.current.hasNode(A)&&(e.current.updateNodeAttribute(A,"x",p=>(p!=null?p:0)+c),e.current.updateNodeAttribute(A,"y",p=>(p!=null?p:0)+h),r())})}else if(n.key==="f"&&u)t(T(u));else if(n.key==="z"&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey))R&&n.preventDefault(),t(Pe());else if(n.key==="s")t(T("select"));else if((n.key==="c"||n.key==="x")&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey)){const o=Me(e.current,y);navigator.clipboard.writeText(o),n.key==="x"&&(t(Z()),y.forEach(c=>{e.current.hasNode(c)?e.current.dropNode(c):e.current.hasEdge(c)&&e.current.dropEdge(c)}),r())}else if(n.key==="v"&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey)){const o=await navigator.clipboard.readText(),{x:c,y:h}=z(C/2,I/2,s,l),{nodes:A,edges:p}=je(o,e.current,$(c,5),$(h,5));r();const M=structuredClone(A);p.forEach(_=>M.add(_)),t(Y(M))}else(R&&n.key==="z"&&n.metaKey&&n.shiftKey||!R&&n.key==="y"&&n.ctrlKey)&&t(Ie())}),[a,x]=v.useState({sx:0,sy:0,ex:0,ey:0});return v.useEffect(()=>{x({sx:k.x<=g.x?k.x:g.x,ex:k.x>g.x?k.x:g.x,sy:k.y<=g.y?k.y:g.y,ey:k.y>g.y?k.y:g.y})},[g.x,g.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:I,width:C,viewBox:"".concat(l.x," ").concat(l.y," ").concat(C*s/100," ").concat(I*s/100),onPointerDown:H,onPointerMove:Q,onPointerUp:ee,onWheel:te,tabIndex:0,onKeyDown:se,children:[E.jsx(Oe,{}),d==="select"&&k.x!=0&&k.y!=0&&E.jsx("rect",{x:a.sx,y:a.sy,width:a.ex-a.sx,height:a.ey-a.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ze as default};
