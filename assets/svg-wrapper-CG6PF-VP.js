import{j as C}from"./chakra-Bbq65mY9.js";import{N as Tt,ap as Et,aq as Ot,a3 as kt,k as Z,o as K,ar as Xt,as as Yt,at as Vt,au as wt,c as $t,d as st,p as Bt,av as Ct,aw as G,ax as tt,ay as ct,T as ot,az as Nt,aA as zt,aB as V,q as lt,t as rt,aC as Pt,n as it,m as Ft,l as _t,r as dt,E as ut,v as mt,y as xt,U as q,aD as Ut,aE as Qt,S as Zt,aF as qt,a0 as Gt,a9 as nt,A as gt,am as Jt,an as te,z as Dt,a1 as ee}from"./index-BoPCO3dq.js";import{s as ht,u as Rt,f as Wt,g as ne,b as se,c as oe,e as ie,h as re,F as ae,l as ce,S as le,j as de}from"./master-manager-BEvcaHku.js";import{j as Ht,b as j}from"./react-DsCD0OwY.js";import{u as Y,e as ue,i as he}from"./clipboard-Cw-mH2px.js";import{m as ft}from"./misc-nodes-DY-YYOzb.js";const fe={[kt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[kt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ye=t=>{const e=fe[t];return e.at(Math.floor(Math.random()*e.length))},Lt=Ht("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:h,rejectWithValue:u})=>{const{token:s}=e().account;if(!s){h(Et({cityName:t,names:[]}));return}const c=await fetch("".concat(Ot,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(s)}});if(!c.ok)return Tt.warn("Failed to fetch random station names",c.statusText),u(c.statusText);const i=await c.json();h(Et({cityName:t,names:i}))}),Mt=Ht("runtime/getOneStationName",async(t,{getState:e,dispatch:h})=>{var y;const{stationNames:u}=e().runtime,s=u[t];if(((y=s==null?void 0:s.length)!=null?y:0)==0)return Tt.debug("No random station names in cache, using fallback"),h(Lt({cityName:t})),Object.values(ye(t));const c=structuredClone(s),i=c.shift();return h(Et({cityName:t,names:c})),c.length<3&&h(Lt({cityName:t})),Object.values(i)}),Kt=(t,e,h,u,s,c)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return jt(t,e,h,u,s)?{x1:e,y1:h,x2:u,y2:s,offset:c.offsetFrom}:void 0;const[i,y]=[c.offsetFrom,c.offsetTo];for(let b=0;b<Math.PI;b+=Math.PI/8)for(let o=b,r=0;r<2;r++,o+=Math.PI){const[f,S,w,E]=[Math.sin(b)*i,Math.cos(b)*i,Math.sin(o)*y,Math.cos(o)*y];if(jt(t,e+f,h+S,u+w,s+E))return{x1:e+f,y1:h+S,x2:u+w,y2:s+E,offset:0}}},pe=(t,e,h,u,s,c)=>t===h?{x1:t+5*c,y1:e,x2:h+5*c,y2:u,offset:s}:e===u?{x1:t,y1:e+5*c,x2:h,y2:u+5*c,offset:s}:{x1:t+5*Math.SQRT1_2*c,y1:e+5*Math.SQRT1_2*c,x2:h+5*Math.SQRT1_2*c,y2:u+5*Math.SQRT1_2*c,offset:s},jt=(t,e,h,u,s)=>!!((e===u||h===s)&&[Z.Diagonal,Z.Perpendicular].includes(t)||Math.abs((s-h)/(u-e))===1&&[Z.Diagonal,Z.RotatePerpendicular].includes(t)),ge=(t,e)=>{const h=[],u=[];return Object.values(e).forEach(s=>{var N;if(s.length===1){u.push(...s.map(g=>g.edge));return}const c=t.getEdgeAttribute(s.at(0),"type");if(!s.every(g=>t.getEdgeAttribute(g,"type")===c)){u.push(...s.map(g=>g.edge));return}const i=t.getEdgeAttribute(s.at(0),"style");if(!s.every(g=>t.getEdgeAttribute(g,"style")===i)){u.push(...s.map(g=>g.edge));return}const y={},b=new Set,o=new Set,r=Object.fromEntries(s.map(g=>{var v,L;const[I,d]=t.extremities(g);return y[I]=((v=y[I])!=null?v:0)+1,y[d]=((L=y[d])!=null?L:0)+1,b.add(I),o.add(d),[I,[g.edge,d]]})),f=Array.from(b).filter(g=>y[g]===1),S=Array.from(o).filter(g=>y[g]===1);if(f.length!==1||S.length!==1){u.push(...s.map(g=>g.edge));return}const w=f[0],E=S[0];if(w===E){u.push(...s.map(g=>g.edge));return}const z=[r[w][0]];let D=r[w][1];for(let g=1;g<s.length;g=g+1){const I=(N=r[D])==null?void 0:N.at(1);if(!I){u.push(...s.map(d=>d.edge));return}z.push(r[D][0]),D=I}if(D!==E||z.length!==s.length){u.push(...s.map(g=>g.edge));return}h.push(z)}),{allReconciledLines:h,danglingLines:u}},me=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const h=e.map(s=>{var S,w,E;const[c,i]=t.extremities(s),y=t.getNodeAttributes(c),b=t.getNodeAttributes(i),{type:o}=t.getEdgeAttributes(s),r=(S=t.getEdgeAttribute(s,o))!=null?S:K[o].defaultAttrs,f=Kt(o,y.x,y.y,b.x,b.y,r);if(f){const{x1:z,y1:D,x2:N,y2:g,offset:I}=f;return K[Z.Simple].generatePath(z,N,D,g,{offset:I})}return(E=(w=K[o])==null?void 0:w.generatePath(y.x,b.x,y.y,b.y,r))!=null?E:"M ".concat(y.x," ").concat(y.y," L ").concat(b.x," ").concat(b.y)});let u="".concat(h[0]," ");for(let s=1;s<e.length;s=s+1)u+=h[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return u},xe=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),be=t=>{const e={},h={},u=[],s={},c=[];for(const o of t.edgeEntries()){const[r,f,S,w]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],E=o.attributes[o.attributes.type],z=Kt(o.attributes.type,r,f,S,w,E);h[o.edge]=z}for(const o of t.edgeEntries()){let r=h[o.edge];const{parallelIndex:f}=o.attributes;if(f>=0){const S=Xt(t,o.attributes.type,o.edge),w=h[S];if(!w){u.push(o);continue}if(f>0){const{x1:E,y1:z,x2:D,y2:N,offset:g}=w;r=pe(E,z,D,N,g,f)}}if(o.attributes.reconcileId!==""){const S=o.attributes.reconcileId;S in s?s[S].push(o):s[S]=[o];continue}if(r){const S=o.edge,w=o.attributes,{x1:E,y1:z,x2:D,y2:N,offset:g}=r;e[S]={attr:w,path:K[Z.Simple].generatePath(E,D,z,N,{offset:g})};continue}c.push(o)}const i=new Set;for(;u.length;){const o=u.pop();if(i.has(o.edge))continue;const{parallel:r}=Yt(t,o);if(!r.length)continue;r.forEach(S=>i.add(S.edge));const f=Vt(r);for(const S of r){const w=S.edge;e[w]={attr:S.attributes,path:f[w]}}}const{allReconciledLines:y,danglingLines:b}=ge(t,s);for(const o of y){const r=me(t,o);if(!r)continue;const f=o[0];e[f]={attr:t.getEdgeAttributes(f),path:r}}for(const o of b){const r=t.getEdgeAttributes(o),[f,S]=t.extremities(o),w=t.getNodeAttributes(f),E=t.getNodeAttributes(S);e[o]={attr:r,path:K[Z.Simple].generatePath(w.x,E.x,w.y,E.y,K[Z.Simple].defaultAttrs)}}for(const o of c){const r=o.edge,f=o.attributes.type,S=o.attributes,[w,E,z,D]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(f in K)){e[r]={attr:S,path:"M ".concat(w," ").concat(E," L ").concat(z," ").concat(D)};continue}e[r]={attr:S,path:K[f].generatePath(w,z,E,D,S[f])}}return Object.entries(e).map(([o,r])=>({id:o,type:"line",line:r}))},It=t=>{const{id:e,x:h,y:u,handlePointerDown:s,handlePointerMove:c,handlePointerUp:i}=t,y=j.useCallback(r=>s(e,r),[e,s]),b=j.useCallback(r=>c(e,r),[e,c]),o=j.useCallback(r=>i(e,r),[e,i]);return C.jsx("g",{id:e,transform:"translate(".concat(h-6.4," ").concat(u-6.4,")scale(0.025)"),onPointerDown:y,onPointerMove:b,onPointerUp:o,style:{cursor:"move"},children:C.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Se=t=>{const{id:e,path:h,handlePointerDown:u}=t,s=j.useCallback(c=>u(e,c),[e,u]);return C.jsx("path",{id:e,d:h,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},ve=j.memo(t=>{var b,o,r,f,S,w,E,z,D,N,g,I;const{elements:e,handlePointerDown:h,handlePointerMove:u,handlePointerUp:s,handleEdgePointerDown:c}=t,i=Object.fromEntries(Array.from({length:21},(d,v)=>[v-10,{pre:[],main:[],post:[]}]));for(const d of e)if(d.type==="line"){const v=d.line.attr.type,L=d.line.attr.style,k=d.line.attr[L],F=(b=wt[L])==null?void 0:b.preComponent;F&&i[d.line.attr.zIndex].pre.push(C.jsx(F,{id:d.id,type:v,path:d.line.path,styleAttrs:k,newLine:!1,handlePointerDown:c},"".concat(d.id,".pre")));const M=(r=(o=wt[L])==null?void 0:o.component)!=null?r:Se;i[d.line.attr.zIndex].main.push(C.jsx(M,{id:d.id,type:v,path:d.line.path,styleAttrs:k,newLine:!1,handlePointerDown:c},d.id));const U=(f=wt[L])==null?void 0:f.postComponent;U&&i[d.line.attr.zIndex].post.push(C.jsx(U,{id:d.id,type:v,path:d.line.path,styleAttrs:k,newLine:!1,handlePointerDown:c},"".concat(d.id,".post")))}else if(d.type==="station"){const v=d.station,L=v.type,k=(S=ht[L])==null?void 0:S.preComponent;k&&i[d.station.zIndex].pre.push(C.jsx(k,{id:d.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},"".concat(d.id,".pre")));const F=(E=(w=ht[L])==null?void 0:w.component)!=null?E:It;i[d.station.zIndex].main.push(C.jsx(F,{id:d.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},d.id));const M=(z=ht[L])==null?void 0:z.postComponent;M&&i[d.station.zIndex].post.push(C.jsx(M,{id:d.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},"".concat(d.id,".post")))}else if(d.type==="misc-node"){const v=d.miscNode,L=v.type,k=(D=ft[L])==null?void 0:D.preComponent;k&&i[d.miscNode.zIndex].pre.push(C.jsx(k,{id:d.id,x:v.x,y:v.y,attrs:v[L],handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},"".concat(d.id,".pre")));const F=(g=(N=ft[L])==null?void 0:N.component)!=null?g:It;i[d.miscNode.zIndex].main.push(C.jsx(F,{id:d.id,x:v.x,y:v.y,attrs:v[L],handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},d.id));const M=(I=ft[L])==null?void 0:I.postComponent;M&&i[d.miscNode.zIndex].post.push(C.jsx(M,{id:d.id,x:v.x,y:v.y,attrs:v[L],handlePointerDown:h,handlePointerMove:u,handlePointerUp:s},"".concat(d.id,".post")))}return Array.from({length:21},(d,v)=>(v-10).toString()).map(d=>[...i[d].pre,...i[d].main,...i[d].post]).flat()},(t,e)=>t.elements===e.elements),Ae=[...Object.values(Zt),Pt.Virtual,Pt.Master,Pt.LondonArrow],we=()=>{const t=$t(),e=j.useRef(window.graph),h=()=>{t(lt()),t(rt()),t(mt(e.current.export()))},{telemetry:{project:u},preference:{autoParallel:s}}=st(A=>A.app),{svgViewBoxZoom:c,svgViewBoxMin:i}=st(A=>A.param),{selected:y,refresh:{nodes:b,edges:o},mode:r,active:f,keepLastPath:S,theme:w}=st(A=>A.runtime),E=Rt(),{height:z,width:D}=Bt(E),[N,g]=j.useState(),[I,d]=j.useState({dx:0,dy:0}),[v,L]=j.useState([]),[k,F]=j.useState([]),[M,U]=j.useState([]);j.useEffect(()=>{if(!N)return;console.log("refresh snap lines");const A=Ct(i,c,D,z),_=Wt(e.current,...Object.values(A));F(_),L(ne(e.current,_))},[i,c,D,z,N]);const yt=Y((A,_)=>{_.stopPropagation(),r==="select"&&t(G("free"));const W=_.currentTarget,{x:B,y:T}=tt(_);W.setPointerCapture(_.pointerId),U([]),g({x:B,y:T}),t(ct(A)),_.shiftKey?y.has(A)?t(Nt(A)):t(zt(A)):y.has(A)||t(ot(new Set([A])))}),bt=Y((A,_)=>{const{x:W,y:B}=tt(_);if(r==="free"&&f===A){if(_.altKey)U([]),y.forEach(T=>{e.current.hasNode(T)&&e.current.updateNodeAttributes(T,O=>({...O,x:V(O.x-(N.x-W)*c/100,5),y:V(O.y-(N.y-B)*c/100,5)}))});else{const T=e.current.getNodeAttribute(A,"x"),O=e.current.getNodeAttribute(A,"y"),R=T-(N.x-W)*c/100,H=O-(N.y-B)*c/100;let $=R,Q=H;if(se(A,e.current)){let a=M;if(a.length!==0&&(a=a.filter(l=>oe(l,R,H)<=6)),a.length<2){const{l,d:m}=ie(R,H,v,k.filter(P=>!y.has(P)&&!a.some(X=>X.node===P))),x=a.length===0||!a.some(P=>P.a===l.a&&P.b===l.b);m<3&&a.length<2&&x&&a.push(l)}if(a.length===1){const l=a[0];if(l.a==0)Q=-l.c/l.b;else if(l.b==0)$=-l.c/l.a;else{const m=-l.a/l.b,x=-l.c/l.b;Q=m*$+x}}else if(a.length===2){const l=a[0],m=a[1],x=l.a*m.b-m.a*l.b;x!==0&&($=-(l.c*m.b-m.c*l.b)/x,Q=-(l.a*m.c-m.a*l.c)/x)}U(a)}const n=$-T,p=Q-O;y.forEach(a=>{e.current.hasNode(a)&&e.current.updateNodeAttributes(a,l=>({...l,x:V(l.x+n,.01),y:V(l.y+p,.01)}))})}t(lt()),t(rt())}else r.startsWith("line")&&d({dx:(N.x-W)*c/100,dy:(N.y-B)*c/100})}),pt=Y((A,_)=>{if(r.startsWith("line")){S||t(G("free"));const W=e.current.hasNode(f)&&Ae.includes(e.current.getNodeAttribute(f,"type"));["stn_core_","virtual_circle_"].forEach(T=>{var $,Q;const R=(Q=($=document.elementsFromPoint(_.clientX,_.clientY)[0].attributes)==null?void 0:$.getNamedItem("id"))==null?void 0:Q.value,H=R==null?void 0:R.startsWith(T);if(W&&H){const n=r.slice(5),p="line_".concat(it(10)),[a,l]=[f,R.slice(T.length)],m=s?Ft(e.current,n,a,l,"from"):-1;e.current.addDirectedEdgeWithKey(p,a,l,{visible:!0,zIndex:0,type:n,[n]:structuredClone(K[n].defaultAttrs),style:_t.SingleColor,[_t.SingleColor]:{color:w},reconcileId:"",parallelIndex:m}),t(ot(new Set([p]))),u&&dt.event(ut.ADD_LINE,{type:n})}}),t(rt()),t(mt(e.current.export()))}else if(r==="free"&&f){const{x:W,y:B}=tt(_);N.x-W===0&&N.y-B===0||t(mt(e.current.export()))}U([]),g(void 0),t(ct(void 0))}),St=Y((A,_)=>{if(_.stopPropagation(),_.shiftKey||t(xt()),_.shiftKey&&y.has(A)?t(Nt(A)):t(zt(A)),r.startsWith("station")||r.startsWith("misc-node-virtual")||r.startsWith("misc-node-master")){const W=_.clientX-document.getElementById("canvas").getBoundingClientRect().left,B=_.clientY-document.getElementById("canvas").getBoundingClientRect().top,T=r.startsWith("station"),O=it(10),R=T?"stn_".concat(O):"misc_node_".concat(O),H=T?r.slice(8):r.slice(10),{x:$,y:Q}=q(W,B,c,i),n=T?structuredClone(ht[H].defaultAttrs):structuredClone(ft[H].defaultAttrs);"color"in n&&(n.color=w),e.current.addNode(R,{visible:!0,zIndex:0,x:V($,5),y:V(Q,5),type:H,[H]:n});const p=e.current.getEdgeAttributes(A),{zIndex:a,type:l,style:m}=p,x=p[l],P=p[m],[X,at]=e.current.extremities(A),et=s?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(it(10)),X,R,{visible:!0,zIndex:a,type:l,[l]:structuredClone(x),style:m,[m]:structuredClone(P),reconcileId:"",parallelIndex:et}),e.current.addDirectedEdgeWithKey("line_".concat(it(10)),R,at,{visible:!0,zIndex:a,type:l,[l]:structuredClone(x),style:m,[m]:structuredClone(P),reconcileId:"",parallelIndex:et}),e.current.dropEdge(A),h(),u&&(dt.event(ut.ADD_STATION,{type:H}),dt.event(ut.ADD_LINE,{type:l})),t(G("free")),t(ot(new Set([R])))}}),vt=j.useMemo(()=>[...be(e.current),...xe(e.current)],[o,b]),At=Ut.component;return C.jsxs(C.Fragment,{children:[C.jsx(ve,{elements:vt,handlePointerDown:yt,handlePointerMove:bt,handlePointerUp:pt,handleEdgePointerDown:St}),r.startsWith("line")&&f&&f!=="background"&&C.jsx(At,{id:"line_create_in_progress___no_use",type:r.slice(5),path:K[r.slice(5)].generatePath(e.current.getNodeAttribute(f,"x"),e.current.getNodeAttribute(f,"x")-I.dx,e.current.getNodeAttribute(f,"y"),e.current.getNodeAttribute(f,"y")-I.dy,K[r.slice(5)].defaultAttrs),styleAttrs:{color:w},newLine:!0,handlePointerDown:()=>{}}),M.length!==0&&M.map(A=>C.jsx("path",{d:K[Z.Simple].generatePath(...Qt(A,Ct(i,c,D,z)),K[Z.Simple].defaultAttrs),stroke:"cyan",strokeWidth:c/100},"line_polyline_".concat(A.a,"_").concat(A.b,"_").concat(A.c,"_").concat(A.node)))]})},_e=()=>{const t=$t(),e=j.useRef(window.graph),h=()=>{t(lt()),t(rt()),t(mt(e.current.export()))},{activeSubscriptions:u}=st(n=>n.account),{telemetry:{project:s},preference:{randomStationsNames:c}}=st(n=>n.app),{svgViewBoxZoom:i,svgViewBoxMin:y}=st(n=>n.param),{mode:b,lastTool:o,active:r,selected:f,keepLastPath:S,theme:w,refresh:{nodes:E},masterNodesCount:z,parallelLinesCount:D}=st(n=>n.runtime),N=Rt(),{height:g,width:I}=Bt(N),d=!u.RMP_CLOUD&&z+1>qt,v=!u.RMP_CLOUD&&D+1>Gt,L=!u.RMP_CLOUD||c==="none";j.useEffect(()=>{const n=re(e.current);Object.entries(n).filter(([p,a])=>a&&p in ae).forEach(([p])=>ce(p))},[E]);const[k,F]=j.useState({x:0,y:0}),[M,U]=j.useState({x:0,y:0}),[yt,bt]=j.useState({x:0,y:0}),[pt,St]=j.useState({x:0,y:0}),vt=Y(async n=>{const{x:p,y:a}=tt(n);if(b.startsWith("station")){t(G("free"));const l=it(10),m="stn_".concat(l),x=b.slice(8),P=structuredClone(ht[x].defaultAttrs);if("color"in P&&(P.color=w),!L){const et=await t(Mt(kt.Shmetro));if(Mt.fulfilled.match(et)){const J=et.payload;P.names.length>J.length?J.push(...Array(P.names.length-J.length).fill(J.at(-1))):P.names.length<J.length&&J.splice(P.names.length,J.length-P.names.length),P.names=J}}const{x:X,y:at}=q(p,a,i,y);e.current.addNode(m,{visible:!0,zIndex:0,x:V(X,5),y:V(at,5),type:x,[x]:P}),h(),s&&dt.event(ut.ADD_STATION,{type:x}),t(ot(new Set([m])))}else if(b.startsWith("misc-node")){t(G("free"));const l=it(10),m="misc_node_".concat(l),x=b.slice(10),{x:P,y:X}=q(p,a,i,y);e.current.addNode(m,{visible:!0,zIndex:0,x:V(P,5),y:V(X,5),type:x,[x]:structuredClone(ft[x].defaultAttrs)}),h(),s&&dt.event(ut.ADD_STATION,{type:x}),t(ot(new Set([m])))}else b==="free"||b.startsWith("line")?(b.startsWith("line")&&(t(G("free")),S&&t(ee(!1))),bt({x:p,y:a}),St(y),n.shiftKey||(t(ct("background")),t(xt()))):b==="select"&&(F(q(p,a,i,y)),U(q(p,a,i,y)))}),At=Y(n=>{if(b==="select"){if(k.x!=0&&k.y!=0){const{x:p,y:a}=tt(n);U(q(p,a,i,y))}}else if(r==="background"){const{x:p,y:a}=tt(n);t(gt({x:pt.x+(yt.x-p)*i/100,y:pt.y+(yt.y-a)*i/100}))}}),A=Y(n=>{if(b==="select"){const{x:p,y:a}=tt(n),{x:l,y:m}=q(p,a,i,y),x=Wt(e.current,k.x,k.y,l,m),P=de(e.current,new Set(x));t(ot(new Set([...n.shiftKey?f:[],...x,...P]))),t(G("free")),F({x:0,y:0}),U({x:0,y:0})}r==="background"&&!n.shiftKey&&t(ct(void 0))}),_=Y(n=>{let p=i;n.deltaY>0&&i+10<400?p=i+10:n.deltaY<0&&i-10>0&&(p=i-10),t(Dt(p));const{x:a,y:l}=tt(n),m=n.currentTarget.getBoundingClientRect(),[x,P]=[a/m.width,l/m.height];t(gt({x:y.x+a*i/100-I*p/100*x,y:y.y+l*i/100-g*p/100*P}))}),W=Y(async n=>{if(nt?n.key==="Backspace":n.key==="Delete")f.size>0&&(f.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(xt()),h());else if(n.key.startsWith("Arrow")){const a=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,l=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(gt(q(100*a,100*l,i,y)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const a=(n.key==="j"?-1:n.key==="l"?1:0)*10,l=(n.key==="i"?-1:n.key==="k"?1:0)*10;f.size>0&&f.forEach(m=>{e.current.hasNode(m)&&(e.current.updateNodeAttribute(m,"x",x=>(x!=null?x:0)+a),e.current.updateNodeAttribute(m,"y",x=>(x!=null?x:0)+l),h())})}else if(n.key==="f"&&o)t(G(o));else if(n.key==="z"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey))nt&&n.preventDefault(),t(Jt()),t(lt()),t(rt());else if(n.key==="s")t(G("select"));else if((n.key==="c"||n.key==="x")&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=ue(e.current,f);navigator.clipboard.writeText(p),n.key==="x"&&(t(xt()),f.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),h())}else if(n.key==="v"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x:a,y:l}=q(I/2,g/2,i,y),{nodes:m,edges:x}=he(p,e.current,d,v,V(a,5),V(l,5));h();const P=structuredClone(m);x.forEach(X=>P.add(X)),t(ot(P))}else(nt&&n.key==="z"&&n.metaKey&&n.shiftKey||!nt&&n.key==="y"&&n.ctrlKey)&&(t(te()),t(lt()),t(rt()))}),[B,T]=j.useState(0),O=Y(n=>{if(n.touches.length===2){t(ct(void 0));const[p,a]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];T(p*p+a*a)}}),R=Y(n=>{if(B!==0&&n.touches.length===2){const[p,a]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],l=p*p+a*a;let m=i;l-B<0&&i+10<=390?m=i+10:l-B>0&&i-10>=10&&(m=i-10),t(Dt(m)),T(l);const x=n.currentTarget.getBoundingClientRect(),[P,X]=[(n.touches[0].clientX+n.touches[1].clientX)/2-x.left,(n.touches[0].clientY+n.touches[1].clientY)/2-x.top],[at,et]=[P/x.width,X/x.height];t(gt({x:y.x+P*i/100-I*m/100*at,y:y.y+X*i/100-g*m/100*et}))}}),H=Y(n=>{B!==0&&T(0)}),[$,Q]=j.useState({sx:0,sy:0,ex:0,ey:0});return j.useEffect(()=>{Q({sx:k.x<=M.x?k.x:M.x,ex:k.x>M.x?k.x:M.x,sy:k.y<=M.y?k.y:M.y,ey:k.y>M.y?k.y:M.y})},[M.x,M.y]),C.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:g,width:I,viewBox:"".concat(y.x," ").concat(y.y," ").concat(I*i/100," ").concat(g*i/100),onPointerDown:vt,onPointerMove:At,onPointerUp:A,onTouchStart:O,onTouchMove:R,onTouchEnd:H,onWheel:_,tabIndex:0,onKeyDown:W,children:[C.jsx(le,{children:C.jsx(we,{})}),b==="select"&&k.x!=0&&k.y!=0&&C.jsx("rect",{x:$.sx,y:$.sy,width:$.ex-$.sx,height:$.ey-$.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),C.jsx("defs",{children:C.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[C.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),C.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{_e as default};
